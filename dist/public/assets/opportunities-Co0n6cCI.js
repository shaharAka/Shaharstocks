import{c as ge,_ as ye,$ as je,j as e,a0 as R,w as ee,x as te,y as se,a1 as we,L as Ne,a2 as Se,r as b,B as f,S as xe,v as O,T as ke,a3 as ve,d as Ce,a as be,Y as Te,u as q,e as le,C as ue,f as Fe,h as pe,a4 as $e,W as Pe,V as Ae,q as Q,b as ce}from"./index-DI4YInPS.js";import{S as X}from"./skeleton-DV0SbO6m.js";import{S as Me,a as De,b as ze,c as Ee,d as oe}from"./select-CpnPcG5S.js";import{S as Ie}from"./switch-DQ4dWgf9.js";import{T as Le,a as Oe,b as he,c as w,d as qe,e as N}from"./table-Dh8obmbd.js";import{C as fe}from"./checkbox-BSel3sVP.js";import{C as Re}from"./candlestick-chart-cell-khzW8HFm.js";import{A as Be,a as He}from"./arrow-up-right-z_vivK5V.js";import{T as Ke}from"./trending-down-DrlS2k3i.js";import{A as _e}from"./arrow-up-down-DSsJmQNo.js";import{A as Qe,a as Ve}from"./arrow-up-DPXP0D04.js";import{S as We}from"./search-DL_GMNbq.js";import"./index-B-eDo8U8.js";import"./LineChart-UzXyIzcs.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=ge("ArrowUpNarrowWide",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M11 12h4",key:"q8tih4"}],["path",{d:"M11 16h7",key:"uosisv"}],["path",{d:"M11 20h10",key:"jvxblo"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=ge("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]),Ge={opportunity:"Opportunity",opportunities:"Opportunities",opportunitiesDescription:"Track insider trading signals sorted by relevance",signal:"Signal",buy:"Purchase",sell:"Sale",insiderPurchase:"Insider Purchase",insiderSale:"Insider Sale",transactionType:"Transaction Type",insiderRole:"Insider Role",picked:"Picked",pick:"Pick",unpick:"Unpick",myPicks:"My Picks",review:"Review",dismiss:"Dismiss",archive:"Archive",refresh:"Refresh",highRisk:"High Conviction",balanced:"Balanced",lowRisk:"Conservative",dataQuality:"Data Quality",sourceConfidence:"Source Confidence",dataRefreshed:"Data Refreshed"};function de(a){return Ge[a]}function Je({microCompleted:a,macroCompleted:d,combinedCompleted:ie,currentPhase:x,stepDetails:S,size:T="sm",showLabels:B=!1,showDetailedProgress:k=!1,className:H}){const g=T==="sm"?"h-3 w-3":"h-4 w-4",j=a&&d&&ie,A=c=>{if(j||x==="complete")return"completed";switch(c){case 1:return x==="data_fetch"?"active":x==="calculating_score"||x==="analyzing"||x==="micro_analysis"||x==="integration"||x==="macro_analysis"?"completed":"pending";case 2:return x==="calculating_score"||x==="analyzing"||x==="micro_analysis"?"active":x==="integration"||x==="macro_analysis"?"completed":"pending";case 3:return x==="integration"||x==="macro_analysis"?"active":j?"completed":"pending";default:return"pending"}},M=[{id:1,label:"Fetching stock data",shortLabel:"Data",icon:ye,status:A(1)},{id:2,label:"Calculating signal",shortLabel:"Signal",icon:je,status:A(2)},{id:3,label:"Generating playbook",shortLabel:"Playbook",icon:Ye,status:A(3)}],y=c=>c==="completed"?we:c==="active"?Ne:Se,D=c=>c==="completed"?"text-success":c==="active"?"text-warning":"text-muted-foreground/40",F=M.find(c=>c.status==="active"),$=(F==null?void 0:F.label)||(j?"Analysis complete":null);return e.jsxs("div",{className:R("flex flex-col gap-1",H),children:[e.jsxs("div",{className:"flex items-center gap-1","data-testid":"analysis-phase-indicator",children:[M.map((c,z)=>{const V=y(c.status),E=D(c.status);return e.jsxs("div",{className:"flex items-center",children:[e.jsxs(ee,{children:[e.jsx(te,{asChild:!0,children:e.jsxs("div",{className:R("flex items-center gap-0.5",E),"data-testid":`status-step-${c.id}`,children:[e.jsx(V,{className:R(g,c.status==="active"&&"animate-spin")}),T==="md"&&e.jsx("span",{className:"text-[10px] font-medium hidden sm:inline",children:c.shortLabel})]})}),e.jsx(se,{side:"top",className:"text-xs z-50",children:e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsxs("span",{className:"font-medium",children:["Step ",c.id,": ",c.label]}),e.jsx("span",{className:R("text-[10px]",c.status==="completed"?"text-success":c.status==="active"?"text-warning":"text-muted-foreground"),children:c.status==="completed"?"Complete":c.status==="active"?"In progress...":"Pending"})]})})]}),z<M.length-1&&e.jsx("div",{className:R("w-2 h-px mx-0.5",c.status==="completed"?"bg-success":"bg-muted-foreground/20")})]},c.id)}),B&&$&&e.jsx("span",{className:R("text-[10px] font-medium ml-1",j?"text-success":"text-warning"),children:$})]}),k&&S&&e.jsxs("div",{className:"text-[10px] text-muted-foreground pl-4",children:[S.substep||S.phase,S.progress&&` (${S.progress})`]})]})}function Ze({stocks:a,users:d,commentCounts:ie,analyses:x=[],selectedTickers:S=new Set,simulatedTickers:T=new Set,onToggleSelection:B,onSelectAll:k,onStockClick:H,viewedTickers:g=[],preserveOrder:j=!1,onFollow:A,onUnfollow:M,onEnterPosition:y,onClosePosition:D,holdings:F=[],followedTickers:$=[],showActions:c=!1}){const[z,V]=b.useState(j?"none":"ticker"),[E,ae]=b.useState("asc"),I=a.length>0&&a.every(t=>S.has(t.ticker));a.some(t=>S.has(t.ticker));const ne=()=>{k&&k(I?[]:a.map(t=>t.ticker))},v=t=>{z===t?ae(E==="asc"?"desc":"asc"):(V(t),ae("asc"))},K=t=>x.find(s=>s.ticker===t),re=(t,s)=>{if(!s||g.includes(t))return!1;const i=new Date(s);return(new Date().getTime()-i.getTime())/(1e3*60*60)<=48},W=t=>{if(!t)return 0;const s=new Date(t);return Math.floor((new Date().getTime()-s.getTime())/(1e3*60*60*24))},U=t=>{if(!t)return"-";const s=t.replace(/[^0-9.]/g,""),i=parseFloat(s);return isNaN(i)?t:i>=1e12?`$${(i/1e12).toFixed(1)}T`:i>=1e9?`$${(i/1e9).toFixed(1)}B`:i>=1e6?`$${(i/1e6).toFixed(1)}M`:i>=1e3?`$${(i/1e3).toFixed(1)}K`:`$${i.toFixed(0)}`},L=t=>F.some(s=>s.ticker===t&&s.quantity>0),r=t=>$.includes(t),p=z==="none"?a:[...a].sort((t,s)=>{let i,l;switch(z){case"ticker":i=t.ticker,l=s.ticker;break;case"price":i=parseFloat(t.currentPrice),l=parseFloat(s.currentPrice);break;case"change":const P=parseFloat(t.currentPrice)-parseFloat(t.previousClose||t.currentPrice),h=parseFloat(s.currentPrice)-parseFloat(s.previousClose||s.currentPrice);i=P,l=h;break;case"insiderPrice":i=t.insiderPrice?parseFloat(t.insiderPrice):0,l=s.insiderPrice?parseFloat(s.insiderPrice):0;break;case"marketCap":const C=J=>{var me;if(!J)return 0;const _=J.match(/\$?([\d.]+)\s*([KMBT])?/i);if(!_)return 0;const Z=parseFloat(_[1]);switch((me=_[2])==null?void 0:me.toUpperCase()){case"K":return Z/1e3;case"M":return Z;case"B":return Z*1e3;case"T":return Z*1e6;default:return Z}};i=C(t.marketCap),l=C(s.marketCap);break;case"recommendation":i=t.recommendation||"",l=s.recommendation||"";break;case"aiScore":const o=K(t.ticker),u=K(s.ticker),Y=(o==null?void 0:o.integratedScore)??(o==null?void 0:o.confidenceScore)??(o==null?void 0:o.financialHealthScore),G=(u==null?void 0:u.integratedScore)??(u==null?void 0:u.confidenceScore)??(u==null?void 0:u.financialHealthScore);i=(o==null?void 0:o.status)==="analyzing"||!Y?0:Y,l=(u==null?void 0:u.status)==="analyzing"||!G?0:G;break;case"daysFromBuy":i=W(t.insiderTradeDate),l=W(s.insiderTradeDate);break;default:i=t.ticker,l=s.ticker}return i<l?E==="asc"?-1:1:i>l?E==="asc"?1:-1:0}),n=({field:t})=>z!==t?e.jsx(_e,{className:"h-4 w-4 ml-1"}):E==="asc"?e.jsx(Qe,{className:"h-4 w-4 ml-1"}):e.jsx(Ve,{className:"h-4 w-4 ml-1"}),m=(t,s)=>{const l=s.toLowerCase().includes("buy")?"BUY":"SELL";return t>=90?`Very Strong ${l} Opportunity`:t>=70?`Strong ${l} Opportunity`:t>=40?`Neutral ${l} Signal`:`Weak ${l} Signal`};return e.jsx("div",{className:"rounded-md border max-h-[calc(100vh-16rem)] overflow-hidden flex flex-col",children:e.jsx("div",{className:"overflow-x-auto overflow-y-auto flex-1",children:e.jsxs(Le,{className:"text-xs",children:[e.jsx(Oe,{className:"sticky top-0 bg-background z-[1]",children:e.jsxs(he,{children:[e.jsx(w,{className:"w-8 px-1",children:k&&e.jsx(fe,{checked:I,onCheckedChange:ne,"aria-label":"Select all","data-testid":"checkbox-select-all"})}),e.jsx(w,{className:"min-w-[50px] sm:min-w-[60px] px-0.5 sm:px-1",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("ticker"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-ticker",children:[e.jsx("span",{className:"hidden sm:inline",children:"Ticker"}),e.jsx("span",{className:"sm:hidden",children:"Tick"}),e.jsx(n,{field:"ticker"})]})}),e.jsx(w,{className:"hidden md:table-cell min-w-[100px] px-1",children:"Company"}),e.jsx(w,{className:"text-right w-[60px] sm:w-[70px] px-1",children:e.jsxs(ee,{children:[e.jsx(te,{asChild:!0,children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("aiScore"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-ai-score",children:[e.jsx("span",{className:"hidden sm:inline",children:"Signal"}),e.jsx("span",{className:"sm:hidden",children:"Sig"}),e.jsx(n,{field:"aiScore"})]})}),e.jsx(se,{side:"top",className:"max-w-xs text-xs",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Signal Strength (0-100)"}),e.jsx("p",{className:"text-muted-foreground",children:"How strongly the fundamentals and analysis support the insider action"}),e.jsx("p",{className:"text-muted-foreground text-[10px] mt-1",children:"100 = very strong signal | 0 = weak/contradictory signal"})]})})]})}),e.jsx(w,{className:"min-w-[45px] sm:min-w-[55px] px-0.5 sm:px-1",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("recommendation"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-recommendation",children:["Type",e.jsx(n,{field:"recommendation"})]})}),e.jsx(w,{className:"text-right min-w-[55px] sm:min-w-[65px] px-0.5 sm:px-1",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("price"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-price",children:[e.jsx("span",{className:"hidden sm:inline",children:"Price"}),e.jsx("span",{className:"sm:hidden",children:"$"}),e.jsx(n,{field:"price"})]})}),e.jsx(w,{className:"hidden lg:table-cell min-w-[100px] px-1",children:"Trend"}),e.jsx(w,{className:"text-right min-w-[55px] sm:min-w-[70px] px-0.5 sm:px-1",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("change"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-change",children:[e.jsx("span",{className:"hidden sm:inline",children:"Chg %"}),e.jsx("span",{className:"sm:hidden",children:"%"}),e.jsx(n,{field:"change"})]})}),e.jsx(w,{className:"text-right hidden xl:table-cell w-[60px] px-1",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("insiderPrice"),className:"px-1 h-7","data-testid":"sort-insider-price",children:["Ins $",e.jsx(n,{field:"insiderPrice"})]})}),e.jsx(w,{className:"hidden xl:table-cell w-[65px] px-1",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("marketCap"),className:"px-1 h-7","data-testid":"sort-market-cap",children:["Mkt Cap",e.jsx(n,{field:"marketCap"})]})}),e.jsx(w,{className:"hidden lg:table-cell min-w-[55px] px-1",children:e.jsxs(f,{variant:"ghost",size:"sm",onClick:()=>v("daysFromBuy"),className:"px-1 h-7","data-testid":"sort-days-from-buy",children:["Days",e.jsx(n,{field:"daysFromBuy"})]})}),c&&e.jsx(w,{className:"w-[100px] px-1 text-right",children:"Actions"})]})}),e.jsx(qe,{children:p.map(t=>{const s=parseFloat(t.currentPrice),i=parseFloat(t.previousClose||t.currentPrice),l=s-i,P=l/i*100,h=l>=0,C=t.insiderPrice?parseFloat(t.insiderPrice):null;return e.jsxs(he,{className:"cursor-pointer hover-elevate h-10",onClick:()=>H(t),"data-testid":`row-stock-${t.ticker}`,children:[e.jsx(N,{className:"w-8 py-1 px-1",onClick:o=>o.stopPropagation(),children:B&&e.jsx(fe,{checked:S.has(t.ticker),onCheckedChange:()=>B(t.ticker),"aria-label":`Select ${t.ticker}`,"data-testid":`checkbox-${t.ticker}`})}),e.jsx(N,{className:"font-medium font-mono py-1 px-0.5 sm:px-1 text-[11px] sm:text-xs","data-testid":`cell-ticker-${t.ticker}`,children:e.jsxs("div",{className:"flex items-center gap-0.5 sm:gap-1.5 flex-wrap",children:[t.isFollowing&&e.jsx(xe,{className:"h-2.5 sm:h-3 w-2.5 sm:w-3 text-primary fill-current","data-testid":`icon-following-${t.ticker}`}),e.jsx("span",{children:t.ticker}),re(t.ticker,t.insiderTradeDate)&&e.jsx(O,{variant:"default",className:"text-[8px] sm:text-[10px] px-0.5 sm:px-1 py-0","data-testid":`badge-new-${t.ticker}`,children:"NEW"}),T.has(t.ticker)&&e.jsx(O,{variant:"outline",className:"text-[8px] sm:text-[10px] px-0.5 sm:px-1 py-0 bg-accent/50 hidden sm:inline-flex","data-testid":`badge-simulated-${t.ticker}`,children:"SIM"}),t.isStale&&e.jsxs(O,{variant:"secondary",className:"text-[8px] sm:text-[10px] px-0.5 sm:px-1 py-0 hidden sm:inline-flex","data-testid":`badge-stale-${t.ticker}`,children:[t.ageDays,"d"]})]})}),e.jsx(N,{className:"hidden md:table-cell max-w-xs truncate text-muted-foreground py-1 px-1","data-testid":`cell-company-${t.ticker}`,children:t.companyName}),e.jsx(N,{className:"text-right py-1 px-1","data-testid":`cell-ai-score-${t.ticker}`,children:(()=>{var _;const o=K(t.ticker);if(!o)return e.jsx("span",{className:"text-[10px] sm:text-xs text-muted-foreground",children:"-"});if(o.status==="pending"||o.status==="analyzing"||o.status==="processing")return e.jsxs(ee,{children:[e.jsx(te,{asChild:!0,children:e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2 justify-end cursor-help",children:[e.jsxs(O,{variant:"outline",className:"text-[9px] sm:text-xs px-1",children:[e.jsx("span",{className:"hidden sm:inline",children:"Analyzing..."}),e.jsx("span",{className:"sm:hidden",children:"..."})]}),e.jsx(Je,{microCompleted:t.microAnalysisCompleted,macroCompleted:t.macroAnalysisCompleted,combinedCompleted:t.combinedAnalysisCompleted,currentPhase:(_=t.analysisJob)==null?void 0:_.currentStep,size:"sm"})]})}),e.jsxs(se,{side:"left",className:"text-xs max-w-xs",children:[e.jsx("p",{className:"font-semibold mb-1",children:"AI Analysis in Progress"}),e.jsx("p",{className:"text-muted-foreground",children:"Our system is analyzing SEC filings, financials, and sector data to generate a signal score."})]})]});if(o.status==="failed")return e.jsx(O,{variant:"destructive",className:"text-[9px] sm:text-xs px-1",children:"Err"});const u=o.integratedScore??o.confidenceScore??o.financialHealthScore,Y=u>=90,G=u>=70&&u<90,J=u>=50&&u<70;return e.jsxs(ee,{children:[e.jsx(te,{asChild:!0,children:e.jsxs(O,{className:R("font-mono transition-all border-0 cursor-help text-[10px] sm:text-xs px-1 sm:px-1.5",Y&&"bg-amber-500 text-white sm:text-sm font-bold shadow-md dark:bg-amber-600",G&&"bg-amber-100 text-amber-700 font-semibold dark:bg-amber-950 dark:text-amber-400",J&&"bg-secondary text-secondary-foreground",!J&&!G&&!Y&&"bg-secondary text-muted-foreground opacity-60"),"data-testid":`badge-signal-${t.ticker}`,children:[e.jsxs("span",{className:"hidden sm:inline",children:[u,"/100"]}),e.jsx("span",{className:"sm:hidden",children:u})]})}),e.jsx(se,{side:"left",className:"text-xs",children:m(u,t.recommendation||"")})]})})()}),e.jsx(N,{className:"py-1 px-0.5 sm:px-1",children:t.recommendation&&e.jsxs(O,{variant:t.recommendation.toLowerCase().includes("buy")?"default":"destructive",className:"text-[8px] sm:text-[10px] px-0.5 sm:px-1","data-testid":`badge-rec-${t.ticker}`,children:[t.recommendation.toLowerCase().includes("buy")?e.jsx(Be,{className:"h-2 sm:h-2.5 w-2 sm:w-2.5 mr-0.5"}):e.jsx(He,{className:"h-2 sm:h-2.5 w-2 sm:w-2.5 mr-0.5"}),e.jsx("span",{className:"hidden sm:inline",children:t.recommendation.replace("_"," ").toUpperCase()}),e.jsx("span",{className:"sm:hidden",children:t.recommendation.toLowerCase().includes("buy")?"B":"S"})]})}),e.jsxs(N,{className:"text-right font-mono py-1 px-0.5 sm:px-1 text-[10px] sm:text-xs","data-testid":`cell-price-${t.ticker}`,children:["$",s.toFixed(2)]}),e.jsx(N,{className:"hidden lg:table-cell w-24 py-1 px-1","data-testid":`cell-chart-${t.ticker}`,children:e.jsx(Re,{ticker:t.ticker,height:40})}),e.jsx(N,{className:"text-right py-1 px-0.5 sm:px-1",children:e.jsxs("div",{className:`flex items-center justify-end gap-0.5 text-[10px] sm:text-xs ${h?"text-success":"text-destructive"}`,children:[h?e.jsx(ke,{className:"h-2 sm:h-2.5 w-2 sm:w-2.5"}):e.jsx(Ke,{className:"h-2 sm:h-2.5 w-2 sm:w-2.5"}),e.jsxs("span",{className:"font-mono font-medium",children:[h?"+":"",P.toFixed(1),"%"]})]})}),e.jsx(N,{className:"text-right font-mono text-muted-foreground hidden xl:table-cell py-1 px-1",children:C?`$${C.toFixed(2)}`:"-"}),e.jsx(N,{className:"text-right text-muted-foreground text-xs hidden xl:table-cell py-1 px-1 font-mono",children:U(t.marketCap)}),e.jsx(N,{className:"hidden lg:table-cell py-1 px-1",children:t.insiderTradeDate&&e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground","data-testid":`text-days-from-buy-${t.ticker}`,children:[e.jsx(ve,{className:"h-2.5 w-2.5"}),e.jsxs("span",{children:[W(t.insiderTradeDate),"d"]})]})}),c&&e.jsx(N,{className:"py-1 px-1",onClick:o=>o.stopPropagation(),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[A&&!r(t.ticker)&&e.jsxs(f,{size:"sm",variant:"ghost",className:"h-6 px-2 text-[10px]",onClick:()=>A(t),"data-testid":`button-follow-${t.ticker}`,children:[e.jsx(xe,{className:"h-3 w-3 mr-1"}),"Follow"]}),M&&r(t.ticker)&&e.jsx(f,{size:"sm",variant:"ghost",className:"h-6 px-2 text-[10px] text-muted-foreground",onClick:()=>M(t.ticker),"data-testid":`button-unfollow-${t.ticker}`,children:"Unfollow"}),y&&!L(t.ticker)&&r(t.ticker)&&e.jsx(f,{size:"sm",variant:"default",className:"h-6 px-2 text-[10px]",onClick:()=>y(t.ticker,s),"data-testid":`button-enter-position-${t.ticker}`,children:"Enter"}),D&&L(t.ticker)&&e.jsx(f,{size:"sm",variant:"destructive",className:"h-6 px-2 text-[10px]",onClick:()=>D(t.ticker),"data-testid":`button-close-position-${t.ticker}`,children:"Close"})]})})]},t.id)})})]})})})}function Xe(a){return{id:a.id,opportunityId:a.id,cadence:a.cadence,userId:"",ticker:a.ticker,companyName:a.companyName,currentPrice:a.currentPrice,previousClose:a.previousClose,insiderPrice:a.insiderPrice,insiderQuantity:a.insiderQuantity,insiderTradeDate:a.insiderTradeDate,insiderName:a.insiderName,insiderTitle:a.insiderTitle,marketPriceAtInsiderDate:a.marketPriceAtInsiderDate,marketCap:a.marketCap,peRatio:a.peRatio,recommendation:a.recommendation,recommendationStatus:"pending",source:a.source,confidenceScore:a.confidenceScore,priceHistory:a.priceHistory,description:a.description,industry:a.industry,country:a.country,webUrl:a.webUrl,ipo:a.ipo,news:a.news,insiderSentimentMspr:a.insiderSentimentMspr,insiderSentimentChange:a.insiderSentimentChange,microAnalysisCompleted:!1,macroAnalysisCompleted:!1,combinedAnalysisCompleted:!1,lastUpdated:a.lastUpdated,rejectedAt:null,userStatus:"pending",isFollowing:!1}}function ht(){const{toast:a}=Ce(),{user:d}=be(),[,ie]=Te(),[x,S]=b.useState("signal"),[T,B]=b.useState(""),[k,H]=b.useState((d==null?void 0:d.showAllOpportunities)??!1),[g,j]=b.useState(new Set),A=r=>{j(p=>{const n=new Set(p);return n.has(r)?n.delete(r):n.add(r),n})},M=r=>{j(new Set(r))};b.useEffect(()=>{(d==null?void 0:d.showAllOpportunities)!==void 0&&H(d.showAllOpportunities)},[d==null?void 0:d.showAllOpportunities]);const{data:y,isLoading:D,error:F}=q({queryKey:["/api/opportunities"],staleTime:2*60*1e3,refetchOnWindowFocus:!0});b.useEffect(()=>{console.log("[OpportunitiesPage] Response:",y),console.log("[OpportunitiesPage] Loading:",D),F&&console.error("[OpportunitiesPage] Error:",F)},[y,D,F]);const $=b.useMemo(()=>y!=null&&y.opportunities?(console.log("[OpportunitiesPage] Converting",y.opportunities.length,"opportunities to stocks"),y.opportunities.map(Xe)):[],[y]),{data:c=[]}=q({queryKey:["/api/stock-analyses",{all:!0}],queryFn:async()=>{const r=await fetch("/api/stock-analyses?all=true",{credentials:"include"});if(!r.ok)throw new Error("Failed to fetch analyses");return r.json()},staleTime:30*1e3,refetchOnWindowFocus:!0,refetchInterval:60*1e3}),{data:z=[]}=q({queryKey:["/api/users"],retry:!1,meta:{ignoreError:!0}}),{data:V=[]}=q({queryKey:["/api/stock-comment-counts"],retry:!1,meta:{ignoreError:!0}}),{data:E}=q({queryKey:["/api/openinsider-config"],retry:!1,meta:{ignoreError:!0}}),{data:ae=[]}=q({queryKey:["/api/stock-views",d==null?void 0:d.id],enabled:!!d,retry:!1,meta:{ignoreError:!0}}),{data:I=[]}=q({queryKey:["/api/users/me/followed"],enabled:!!d,retry:!1,meta:{ignoreError:!0}}),ne=le({mutationFn:async r=>{if(!d)throw new Error("Not authenticated");return await ce("PATCH",`/api/users/${d.id}`,{showAllOpportunities:r})},onSuccess:()=>{Q.invalidateQueries({queryKey:["/api/auth/current-user"]})}}),v=r=>{H(r),ne.mutate(r)},K=le({mutationFn:async r=>await ce("POST",`/api/stocks/${r}/follow`,null),onSuccess:()=>{Q.invalidateQueries({queryKey:["/api/users/me/followed"]}),Q.invalidateQueries({queryKey:["/api/followed-stocks-with-prices"]}),Q.invalidateQueries({queryKey:["/api/followed-stocks-with-status"]}),Q.invalidateQueries({queryKey:["/api/stocks/with-user-status"]}),a({title:"Stock Followed",description:"Day-0 AI analysis has been queued for this stock"})},onError:r=>{var n;const p=(n=r.message)!=null&&n.includes("already following")?"You are already following this stock":"Failed to follow stock";a({title:"Error",description:p,variant:"destructive"})}}),re=le({mutationFn:async r=>await ce("POST",`/api/opportunities/${r}/reject`,null),onSuccess:async()=>{await Q.refetchQueries({queryKey:["/api/opportunities"]}),a({title:"Opportunity Dismissed",description:"This opportunity has been hidden from your view"})},onError:()=>{a({title:"Error",description:"Failed to dismiss opportunity",variant:"destructive"})}}),W=r=>{if(!r)return 0;const p=new Date(r);return Math.floor((new Date().getTime()-p.getTime())/(1e3*60*60*24))},U=r=>{if(!r)return 0;const n=r.replace(/^(USD|US\$|\$|EUR|€|GBP|£)\s*/i,"").trim().toLowerCase().match(/([\d,]+(?:\.\d+)?)\s*([tbmk])?/i);if(!n)return 0;const m=parseFloat(n[1].replace(/,/g,""));if(isNaN(m))return 0;const t=n[2];return t==="t"?m*1e6:t==="b"?m*1e3:t==="m"?m:t==="k"?m*.001:m},L=b.useMemo(()=>{if(!$||$.length===0)return[];const r=new Set(I.map(s=>s.ticker)),n=$.filter(s=>{var l,P;const i=(l=s.recommendation)==null?void 0:l.toLowerCase();if(!i||!i.includes("buy")&&!i.includes("sell")||!k&&!i.includes("buy"))return!1;if(i.includes("buy")){const h=s.insiderPrice?parseFloat(String(s.insiderPrice)):0,C=s.currentPrice?parseFloat(String(s.currentPrice)):0,o=((d==null?void 0:d.optionsDealThresholdPercent)||15)/100;if(C>0&&h<C*o)return!1}if(d!=null&&d.minMarketCapFilter){const h=U(s.marketCap);if(h>0&&h<d.minMarketCapFilter)return!1}if(T.trim()!==""){const h=T.trim().toLowerCase(),C=s.ticker.toLowerCase().includes(h),o=(P=s.companyName)==null?void 0:P.toLowerCase().includes(h);if(!C&&!o)return!1}return!0}).map(s=>{const i=c.find(h=>h.ticker===s.ticker),l=W(s.insiderTradeDate),P=(i==null?void 0:i.integratedScore)??(i==null?void 0:i.confidenceScore)??null;return{...s,signalScore:P,daysSinceTrade:l,isFollowing:r.has(s.ticker)}}),m=new Map;n.forEach(s=>{const i=s.signalScore,l=m.get(s.ticker);l?i!==null&&(l.highestScore===null||i>l.highestScore)?m.set(s.ticker,{...s,highestScore:i}):s.daysSinceTrade<l.daysSinceTrade&&m.set(s.ticker,{...s,highestScore:l.highestScore}):m.set(s.ticker,{...s,highestScore:i})});let t=Array.from(m.values()).filter(s=>{const i=s.highestScore;return i!==null&&i>=70});return t.sort((s,i)=>x==="signal"?(i.highestScore??0)-(s.highestScore??0):x==="daysFromTrade"?s.daysSinceTrade-i.daysSinceTrade:x==="marketCap"?U(i.marketCap)-U(s.marketCap):0),t},[$,c,x,T,k,I,d]);return D?e.jsxs("div",{className:"p-4 md:p-6 space-y-4 md:space-y-6 max-w-7xl",children:[e.jsx(X,{className:"h-8 w-48 mb-2"}),e.jsx("div",{className:"grid gap-4 md:gap-6 sm:grid-cols-2 lg:grid-cols-3",children:[1,2,3].map(r=>e.jsxs(ue,{children:[e.jsxs(Fe,{children:[e.jsx(X,{className:"h-6 w-24 mb-2"}),e.jsx(X,{className:"h-4 w-32"})]}),e.jsxs(pe,{className:"space-y-4",children:[e.jsx(X,{className:"h-8 w-full"}),e.jsx(X,{className:"h-24 w-full"})]})]},r))})]}):e.jsxs("div",{className:"p-4 md:p-6 space-y-4 max-w-7xl",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-xl font-semibold whitespace-nowrap","data-testid":"text-page-title",children:de("opportunities")}),e.jsxs(ee,{children:[e.jsx(te,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"h-6 w-6",tabIndex:0,"aria-label":"Learn how opportunities work","data-testid":"button-help-opportunities",children:e.jsx($e,{className:"h-4 w-4 text-muted-foreground"})})}),e.jsxs(se,{side:"bottom",className:"max-w-sm p-4 space-y-3 text-left",children:[e.jsx("p",{className:"font-semibold text-sm",children:"How the Board Works"}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"High Signal:"})," Stocks with AI score 70+ showing strong opportunity"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Recent:"})," Mid-range scores (40-69) from the last 2 days"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Processing:"})," Awaiting AI analysis"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Community:"})," Stocks with high user engagement"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Rejected:"})," Stocks you've dismissed"]})]}),e.jsxs("div",{className:"pt-2 border-t space-y-1 text-xs text-muted-foreground",children:[e.jsx("p",{children:"Stocks are automatically removed after 10-14 days unless you follow them."}),e.jsxs("p",{children:["Low-confidence signals (score ","<"," 40) are auto-rejected."]})]})]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(We,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),e.jsx(Pe,{placeholder:"Search...",value:T,onChange:r=>B(r.target.value),className:"pl-8 h-8 w-32 text-sm","data-testid":"input-search"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 border rounded-md px-2 h-8",children:[e.jsx(Ae,{htmlFor:"show-all-toggle",className:"text-xs font-medium cursor-pointer whitespace-nowrap",children:k?"All":"Buy"}),e.jsx(Ie,{id:"show-all-toggle",checked:k,onCheckedChange:v,className:"scale-75","data-testid":"toggle-show-all"})]}),e.jsxs(Me,{value:x,onValueChange:r=>S(r),children:[e.jsxs(De,{className:"h-8 w-32 text-xs","data-testid":"select-sort",children:[e.jsx(Ue,{className:"h-3.5 w-3.5 mr-1"}),e.jsx(ze,{})]}),e.jsxs(Ee,{children:[e.jsx(oe,{value:"signal",children:"Signal"}),e.jsx(oe,{value:"daysFromTrade",children:"Recent"}),e.jsx(oe,{value:"marketCap",children:"Market Cap"})]})]})]})]}),e.jsxs("div",{className:"flex gap-4 text-sm items-center justify-between",children:[e.jsx("div",{className:"flex gap-4",children:e.jsxs("div",{children:[e.jsxs("span",{className:"text-muted-foreground",children:["Total ",de("opportunities"),": "]}),e.jsx("span",{className:"font-medium","data-testid":"text-total-count",children:L.length})]})}),g.size>0&&e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:[g.size," selected"]}),e.jsx(f,{size:"sm",onClick:()=>{if(g.size===0){a({title:"No stocks selected",description:"Please select at least one stock to follow",variant:"destructive"});return}const r=new Set(I.map(m=>m.ticker)),p=Array.from(g).filter(m=>!r.has(m)),n=Array.from(g).filter(m=>r.has(m));if(p.length===0){a({title:"Already Following",description:`All ${g.size} selected stocks are already being followed`,variant:"destructive"}),j(new Set);return}p.forEach(m=>{K.mutate(m)}),n.length>0?a({title:"Partially Followed",description:`Following ${p.length} new stocks. ${n.length} already followed.`}):a({title:"Following Stocks",description:`Following ${p.length} stocks`}),j(new Set)},disabled:K.isPending,"data-testid":"button-bulk-follow",children:"Follow Selected"}),e.jsx(f,{size:"sm",variant:"destructive",onClick:()=>{if(g.size===0){a({title:"No stocks selected",description:"Please select at least one stock to reject",variant:"destructive"});return}const p=Array.from(g).map(n=>{const m=L.find(t=>t.ticker===n);return m==null?void 0:m.opportunityId}).filter(n=>!!n);p.forEach(n=>{re.mutate(n)}),a({title:"Dismissing Opportunities",description:`Dismissing ${p.length} opportunities`}),j(new Set)},disabled:re.isPending,"data-testid":"button-bulk-reject",children:"Reject Selected"})]})]}),L.length===0?e.jsx(ue,{children:e.jsx(pe,{className:"p-8 text-center",children:e.jsxs("p",{className:"text-muted-foreground",children:["No ",de("opportunities")," match your current filters."]})})}):e.jsx(Ze,{stocks:L,users:z,commentCounts:V,analyses:c,selectedTickers:g,onToggleSelection:A,onSelectAll:M,viewedTickers:ae,preserveOrder:!0,onStockClick:r=>{ie(`/ticker/${r.ticker}?from=opportunities`)}})]})}export{ht as default};
