import{c as st,a as kt,d as wt,r as m,aa as us,u as U,e as ne,j as e,C as A,f as ie,B as R,H as ms,g as xe,v as Y,a8 as hs,V as re,a9 as Ze,D as Pt,l as Ct,m as St,n as Lt,o as Tt,ab as xs,ac as te,ad as se,ae as je,af as ae,W as De,ag as ve,ah as ps,I as fs,J as gs,K as js,M as vs,N as bs,O as ys,P as Ns,Q as ks,q as X,b as Pe,ai as ws,aj as Ye,ak as lt,al as Dt,am as Ps,an as Cs,ao as Ft,ap as Ss,aq as Ie,ar as at,as as Ls,at as et,au as Ts,av as Ds,a0 as $t,a2 as Fs,h as H,w as dt,x as ut,y as mt,T as Xe,L as be,a3 as $s,z as ht,aw as Rs,a5 as Es,Y as _s}from"./index-DI4YInPS.js";import{T as Rt,a as Et,b as Me,c as ze}from"./tabs-D7P84Hx4.js";import{S as ce}from"./skeleton-DV0SbO6m.js";import{S as As}from"./switch-DQ4dWgf9.js";import{S as ye,a as Ne,b as ke,c as we,d as I,C as Ms,e as zs}from"./select-CpnPcG5S.js";import{i as Is,D as qs}from"./schema-CDsPGLVL.js";import{P as xt}from"./plus-Dkh6wZPX.js";import{P as Bs}from"./pause-B2oYiJbo.js";import{u as Os}from"./index-B-eDo8U8.js";import{C as pt,a as Vs,b as Ks,c as Hs}from"./collapsible-wj_V0Br0.js";import{R as ft,L as gt,X as jt,Y as vt,b as he,T as bt,c as Ws,a as yt,d as Qs}from"./LineChart-UzXyIzcs.js";import{T as Nt}from"./trending-down-DrlS2k3i.js";import{C as Gs}from"./circle-alert-D8Fr0CHp.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Us=st("FlaskConical",[["path",{d:"M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2",key:"pzvekw"}],["path",{d:"M8.5 2h7",key:"csnxdl"}],["path",{d:"M7 16h10",key:"wp8him"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=st("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Js=st("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]),Ys=Is.extend({conditionMetric:lt(["price_change_percent","price_absolute","price_change_from_close_percent"]),conditionOperator:lt([">","<",">=","<=","=="]),conditionValue:Ye.number(),actionQuantity:Ye.number().int().positive().optional(),actionPercentage:Ye.number().min(1).max(100).optional()});function Xs(){const{user:u}=kt(),{toast:k}=wt(),[v,h]=m.useState(!1),[p,L]=m.useState(null),[w,f]=m.useState(!1),[$,M]=m.useState(null),j=us({resolver:ws(Ys),defaultValues:{name:"",enabled:!0,scope:"all_holdings",ticker:void 0,conditions:[],action:"sell",actionParams:void 0,conditionMetric:"price_change_percent",conditionOperator:"<",conditionValue:-7,actionQuantity:void 0,actionPercentage:void 0}}),{data:P,isLoading:W}=U({queryKey:["/api/rules",u==null?void 0:u.id],enabled:!!u,queryFn:async()=>{const s=await fetch("/api/rules",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch rules");return s.json()}}),{data:T}=U({queryKey:["/api/stocks"]}),F=ne({mutationFn:async s=>{const{conditionMetric:d,conditionOperator:V,conditionValue:S,actionQuantity:Z,actionPercentage:J,...fe}=s,le={...fe,conditions:[{metric:d,operator:V,value:S}],actionParams:Z?{quantity:Z}:J?{percentage:J}:void 0};return await Pe("POST","/api/rules",le)},onSuccess:()=>{X.invalidateQueries({queryKey:["/api/rules",u==null?void 0:u.id]}),k({title:"Rule Created",description:"Trading rule has been created successfully"}),j.reset(),h(!1)},onError:()=>{k({title:"Error",description:"Failed to create trading rule",variant:"destructive"})}}),O=ne({mutationFn:async({id:s,data:d})=>{const{conditionMetric:V,conditionOperator:S,conditionValue:Z,actionQuantity:J,actionPercentage:fe,...le}=d,Te={...le,conditions:[{metric:V,operator:S,value:Z}],actionParams:J?{quantity:J}:fe?{percentage:fe}:void 0};return await Pe("PATCH",`/api/rules/${s}`,Te)},onSuccess:()=>{X.invalidateQueries({queryKey:["/api/rules",u==null?void 0:u.id]}),k({title:"Rule Updated",description:"Trading rule has been updated successfully"}),j.reset(),L(null),h(!1)},onError:()=>{k({title:"Error",description:"Failed to update trading rule",variant:"destructive"})}}),Q=ne({mutationFn:async({id:s,enabled:d})=>await Pe("PATCH",`/api/rules/${s}`,{enabled:d}),onSuccess:()=>{X.invalidateQueries({queryKey:["/api/rules",u==null?void 0:u.id]})},onError:()=>{k({title:"Error",description:"Failed to toggle trading rule",variant:"destructive"})}}),oe=ne({mutationFn:async s=>await Pe("DELETE",`/api/rules/${s}`,null),onSuccess:()=>{X.invalidateQueries({queryKey:["/api/rules",u==null?void 0:u.id]}),k({title:"Rule Deleted",description:"Trading rule has been deleted successfully"}),f(!1),M(null)},onError:()=>{k({title:"Error",description:"Failed to delete trading rule",variant:"destructive"})}}),pe=()=>{L(null),j.reset({name:"",enabled:!0,scope:"all_holdings",ticker:void 0,conditions:[],action:"sell",actionParams:void 0,conditionMetric:"price_change_percent",conditionOperator:"<",conditionValue:-7,actionQuantity:void 0,actionPercentage:100}),h(!0)},Ce=s=>{var V,S;L(s);const d=s.conditions&&s.conditions.length>0?s.conditions[0]:null;j.reset({name:s.name,enabled:s.enabled,scope:s.scope||"all_holdings",ticker:s.ticker||void 0,conditions:s.conditions,action:s.action,actionParams:s.actionParams,conditionMetric:(d==null?void 0:d.metric)||"price_change_percent",conditionOperator:(d==null?void 0:d.operator)||"<",conditionValue:(d==null?void 0:d.value)||-7,actionQuantity:(V=s.actionParams)==null?void 0:V.quantity,actionPercentage:(S=s.actionParams)==null?void 0:S.percentage}),h(!0)},Se=s=>{p?O.mutate({id:p.id,data:s}):F.mutate(s)},Le=s=>{Q.mutate({id:s.id,enabled:!s.enabled})},Be=s=>{M(s),f(!0)},$e=s=>{if(!s.conditions||s.conditions.length===0)return"No conditions";const d=s.conditions[0],V={price_change_percent:"price change",price_absolute:"price",price_change_from_close_percent:"change from close"},S={">":"above","<":"below",">=":"at or above","<=":"at or below","==":"equals"},Z=V[d.metric]||d.metric,J=S[d.operator]||d.operator;return d.metric.includes("percent")?`${Z} ${J} ${d.value>0?"+":""}${d.value}%`:`${Z} ${J} $${d.value}`},q=s=>s.scope==="specific_stock"&&s.ticker?s.ticker:s.scope==="all_holdings"?"All holdings":s.scope||"All holdings",E=s=>{var V,S;const d=s.action.toUpperCase();return(V=s.actionParams)!=null&&V.quantity?`${d} ${s.actionParams.quantity} shares`:(S=s.actionParams)!=null&&S.percentage?`${d} ${s.actionParams.percentage}% of position`:s.action==="sell_all"?"SELL ALL (100%)":d},g=j.watch("scope"),Re=j.watch("action"),C=j.watch("conditionMetric");return W?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx(ce,{className:"h-8 w-48 mb-2"}),e.jsx(ce,{className:"h-4 w-96"})]}),e.jsx("div",{className:"space-y-4",children:[1,2,3].map(s=>e.jsx(A,{children:e.jsxs(ie,{children:[e.jsx(ce,{className:"h-6 w-48 mb-2"}),e.jsx(ce,{className:"h-4 w-64"})]})},s))})]}):e.jsxs("div",{className:"p-6 space-y-6 max-w-screen-2xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h1",{className:"text-xl font-semibold whitespace-nowrap","data-testid":"text-page-title",children:"Trading Rules"})}),e.jsxs(R,{size:"sm",onClick:pe,"data-testid":"button-create-rule",children:[e.jsx(xt,{className:"h-4 w-4 mr-1"}),"Create Rule"]})]}),!P||P.length===0?e.jsx(A,{className:"p-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ms,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2","data-testid":"text-no-rules",children:"No Trading Rules"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:'Create trigger-based rules like "Sell if price drops 7% below purchase price"'}),e.jsxs(R,{onClick:pe,"data-testid":"button-create-first-rule",children:[e.jsx(xt,{className:"h-4 w-4 mr-2"}),"Create Your First Rule"]})]})}):e.jsx("div",{className:"space-y-4",children:P.map(s=>e.jsx(A,{"data-testid":`card-rule-${s.id}`,children:e.jsx(ie,{children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(xe,{className:"text-lg","data-testid":`text-rule-name-${s.id}`,children:s.name}),e.jsx(Y,{variant:s.enabled?"default":"secondary","data-testid":`badge-status-${s.id}`,children:s.enabled?"Active":"Inactive"})]}),e.jsxs(hs,{"data-testid":`text-rule-description-${s.id}`,children:[e.jsx("span",{className:"font-medium",children:q(s)})," - ","When ",$e(s),", then ",E(s)]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{htmlFor:`toggle-${s.id}`,className:"text-xs text-muted-foreground",children:s.enabled?e.jsx(_t,{className:"h-3 w-3"}):e.jsx(Bs,{className:"h-3 w-3"})}),e.jsx(As,{id:`toggle-${s.id}`,checked:s.enabled,onCheckedChange:()=>Le(s),"data-testid":`switch-toggle-${s.id}`})]}),e.jsx(R,{variant:"ghost",size:"icon",onClick:()=>Ce(s),"data-testid":`button-edit-${s.id}`,className:"h-11 w-11",children:e.jsx(Js,{className:"h-4 w-4"})}),e.jsx(R,{variant:"ghost",size:"icon",onClick:()=>Be(s.id),"data-testid":`button-delete-${s.id}`,className:"h-11 w-11",children:e.jsx(Ze,{className:"h-4 w-4"})})]})]})})},s.id))}),e.jsx(Pt,{open:v,onOpenChange:h,children:e.jsxs(Ct,{className:"max-w-lg","data-testid":"dialog-rule",children:[e.jsxs(St,{children:[e.jsx(Lt,{"data-testid":"text-dialog-title",children:p?"Edit Trading Rule":"Create Trading Rule"}),e.jsx(Tt,{children:"Create trigger-based rules like stop-loss or take-profit strategies"})]}),e.jsx(xs,{...j,children:e.jsxs("form",{onSubmit:j.handleSubmit(Se),className:"space-y-4 py-4",children:[e.jsx(te,{control:j.control,name:"name",render:({field:s})=>e.jsxs(se,{children:[e.jsx(je,{children:"Rule Name"}),e.jsx(ae,{children:e.jsx(De,{...s,placeholder:"e.g., Stop Loss 7%","data-testid":"input-rule-name"})}),e.jsx(ve,{})]})}),e.jsx(te,{control:j.control,name:"scope",render:({field:s})=>e.jsxs(se,{children:[e.jsx(je,{children:"Apply To"}),e.jsxs(ye,{value:s.value,onValueChange:s.onChange,children:[e.jsx(ae,{children:e.jsx(Ne,{"data-testid":"select-scope",children:e.jsx(ke,{})})}),e.jsxs(we,{children:[e.jsx(I,{value:"all_holdings",children:"All Holdings"}),e.jsx(I,{value:"specific_stock",children:"Specific Stock"})]})]}),e.jsx(ps,{children:g==="all_holdings"?"Rule applies to all stocks in your portfolio":"Rule applies to a specific stock only"}),e.jsx(ve,{})]})}),g==="specific_stock"&&e.jsx(te,{control:j.control,name:"ticker",render:({field:s})=>e.jsxs(se,{children:[e.jsx(je,{children:"Stock Ticker"}),e.jsxs(ye,{value:s.value||"",onValueChange:s.onChange,children:[e.jsx(ae,{children:e.jsx(Ne,{"data-testid":"select-ticker",children:e.jsx(ke,{placeholder:"Select stock"})})}),e.jsx(we,{children:T==null?void 0:T.map(d=>e.jsxs(I,{value:d.ticker,children:[d.ticker," - ",d.companyName]},d.ticker))})]}),e.jsx(ve,{})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{children:"Trigger Condition"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(te,{control:j.control,name:"conditionMetric",render:({field:s})=>e.jsx(se,{children:e.jsxs(ye,{value:s.value,onValueChange:s.onChange,children:[e.jsx(ae,{children:e.jsx(Ne,{"data-testid":"select-metric",children:e.jsx(ke,{})})}),e.jsxs(we,{children:[e.jsx(I,{value:"price_change_percent",children:"% from purchase"}),e.jsx(I,{value:"price_change_from_close_percent",children:"% from close"}),e.jsx(I,{value:"price_absolute",children:"Absolute price"})]})]})})}),e.jsx(te,{control:j.control,name:"conditionOperator",render:({field:s})=>e.jsx(se,{children:e.jsxs(ye,{value:s.value,onValueChange:s.onChange,children:[e.jsx(ae,{children:e.jsx(Ne,{"data-testid":"select-operator",children:e.jsx(ke,{})})}),e.jsxs(we,{children:[e.jsx(I,{value:">",children:"Above"}),e.jsx(I,{value:"<",children:"Below"}),e.jsx(I,{value:">=",children:"At or above"}),e.jsx(I,{value:"<=",children:"At or below"})]})]})})}),e.jsx(te,{control:j.control,name:"conditionValue",render:({field:s})=>e.jsx(se,{children:e.jsx(ae,{children:e.jsx(De,{type:"number",step:"any",...s,onChange:d=>s.onChange(parseFloat(d.target.value)||0),placeholder:C==="price_absolute"?"100.00":"-7","data-testid":"input-value"})})})})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[C==="price_change_percent"&&"Example: -7 means 7% loss from purchase price",C==="price_change_from_close_percent"&&"Example: -5 means 5% drop from previous close",C==="price_absolute"&&"Example: 100 triggers when price reaches $100"]})]}),e.jsx(te,{control:j.control,name:"action",render:({field:s})=>e.jsxs(se,{children:[e.jsx(je,{children:"Action"}),e.jsxs(ye,{value:s.value,onValueChange:s.onChange,children:[e.jsx(ae,{children:e.jsx(Ne,{"data-testid":"select-action",children:e.jsx(ke,{})})}),e.jsxs(we,{children:[e.jsx(I,{value:"sell",children:"Sell (partial or %)"}),e.jsx(I,{value:"sell_all",children:"Sell All (100%)"}),e.jsx(I,{value:"buy",children:"Buy"}),e.jsx(I,{value:"notify",children:"Notify Only"})]})]}),e.jsx(ve,{})]})}),Re!=="notify"&&Re!=="sell_all"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(te,{control:j.control,name:"actionQuantity",render:({field:s})=>e.jsxs(se,{children:[e.jsx(je,{children:"Quantity (shares)"}),e.jsx(ae,{children:e.jsx(De,{type:"number",...s,onChange:d=>s.onChange(d.target.value?parseInt(d.target.value):void 0),value:s.value||"",placeholder:"Leave empty for %","data-testid":"input-action-quantity"})}),e.jsx(ve,{})]})}),e.jsx(te,{control:j.control,name:"actionPercentage",render:({field:s})=>e.jsxs(se,{children:[e.jsx(je,{children:"Or Percentage (%)"}),e.jsx(ae,{children:e.jsx(De,{type:"number",min:"1",max:"100",...s,onChange:d=>s.onChange(d.target.value?parseInt(d.target.value):void 0),value:s.value||"",placeholder:"e.g., 100","data-testid":"input-action-percentage"})}),e.jsx(ve,{})]})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{type:"button",variant:"outline",className:"flex-1",onClick:()=>h(!1),"data-testid":"button-cancel-rule",children:"Cancel"}),e.jsx(R,{type:"submit",className:"flex-1",disabled:F.isPending||O.isPending,"data-testid":"button-save-rule",children:F.isPending||O.isPending?"Saving...":p?"Update Rule":"Create Rule"})]})]})})]})}),e.jsx(fs,{open:w,onOpenChange:f,children:e.jsxs(gs,{"data-testid":"dialog-delete-confirm",children:[e.jsxs(js,{children:[e.jsx(vs,{children:"Delete Trading Rule?"}),e.jsx(bs,{children:"This action cannot be undone. This will permanently delete the trading rule."})]}),e.jsxs(ys,{children:[e.jsx(Ns,{"data-testid":"button-cancel-delete",children:"Cancel"}),e.jsx(ks,{onClick:()=>$&&oe.mutate($),"data-testid":"button-confirm-delete",children:"Delete"})]})]})})]})}var it="Radio",[Zs,At]=Ft(it),[ea,ta]=Zs(it),Mt=m.forwardRef((u,k)=>{const{__scopeRadio:v,name:h,checked:p=!1,required:L,disabled:w,value:f="on",onCheck:$,form:M,...j}=u,[P,W]=m.useState(null),T=at(k,Q=>W(Q)),F=m.useRef(!1),O=P?M||!!P.closest("form"):!0;return e.jsxs(ea,{scope:v,checked:p,disabled:w,children:[e.jsx(Ie.button,{type:"button",role:"radio","aria-checked":p,"data-state":Bt(p),"data-disabled":w?"":void 0,disabled:w,value:f,...j,ref:T,onClick:et(u.onClick,Q=>{p||$==null||$(),O&&(F.current=Q.isPropagationStopped(),F.current||Q.stopPropagation())})}),O&&e.jsx(qt,{control:P,bubbles:!F.current,name:h,value:f,checked:p,required:L,disabled:w,form:M,style:{transform:"translateX(-100%)"}})]})});Mt.displayName=it;var zt="RadioIndicator",It=m.forwardRef((u,k)=>{const{__scopeRadio:v,forceMount:h,...p}=u,L=ta(zt,v);return e.jsx(Ts,{present:h||L.checked,children:e.jsx(Ie.span,{"data-state":Bt(L.checked),"data-disabled":L.disabled?"":void 0,...p,ref:k})})});It.displayName=zt;var sa="RadioBubbleInput",qt=m.forwardRef(({__scopeRadio:u,control:k,checked:v,bubbles:h=!0,...p},L)=>{const w=m.useRef(null),f=at(w,L),$=Os(v),M=Ds(k);return m.useEffect(()=>{const j=w.current;if(!j)return;const P=window.HTMLInputElement.prototype,T=Object.getOwnPropertyDescriptor(P,"checked").set;if($!==v&&T){const F=new Event("click",{bubbles:h});T.call(j,v),j.dispatchEvent(F)}},[$,v,h]),e.jsx(Ie.input,{type:"radio","aria-hidden":!0,defaultChecked:v,...p,tabIndex:-1,ref:f,style:{...p.style,...M,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});qt.displayName=sa;function Bt(u){return u?"checked":"unchecked"}var aa=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],qe="RadioGroup",[ia]=Ft(qe,[Dt,At]),Ot=Dt(),Vt=At(),[ra,na]=ia(qe),Kt=m.forwardRef((u,k)=>{const{__scopeRadioGroup:v,name:h,defaultValue:p,value:L,required:w=!1,disabled:f=!1,orientation:$,dir:M,loop:j=!0,onValueChange:P,...W}=u,T=Ot(v),F=Ps(M),[O,Q]=Cs({prop:L,defaultProp:p??null,onChange:P,caller:qe});return e.jsx(ra,{scope:v,name:h,required:w,disabled:f,value:O,onValueChange:Q,children:e.jsx(Ss,{asChild:!0,...T,orientation:$,dir:F,loop:j,children:e.jsx(Ie.div,{role:"radiogroup","aria-required":w,"aria-orientation":$,"data-disabled":f?"":void 0,dir:F,...W,ref:k})})})});Kt.displayName=qe;var Ht="RadioGroupItem",Wt=m.forwardRef((u,k)=>{const{__scopeRadioGroup:v,disabled:h,...p}=u,L=na(Ht,v),w=L.disabled||h,f=Ot(v),$=Vt(v),M=m.useRef(null),j=at(k,M),P=L.value===p.value,W=m.useRef(!1);return m.useEffect(()=>{const T=O=>{aa.includes(O.key)&&(W.current=!0)},F=()=>W.current=!1;return document.addEventListener("keydown",T),document.addEventListener("keyup",F),()=>{document.removeEventListener("keydown",T),document.removeEventListener("keyup",F)}},[]),e.jsx(Ls,{asChild:!0,...f,focusable:!w,active:P,children:e.jsx(Mt,{disabled:w,required:L.required,checked:P,...$,...p,name:L.name,ref:j,onCheck:()=>L.onValueChange(p.value),onKeyDown:et(T=>{T.key==="Enter"&&T.preventDefault()}),onFocus:et(p.onFocus,()=>{var T;W.current&&((T=M.current)==null||T.click())})})})});Wt.displayName=Ht;var ca="RadioGroupIndicator",Qt=m.forwardRef((u,k)=>{const{__scopeRadioGroup:v,...h}=u,p=Vt(v);return e.jsx(It,{...p,...h,ref:k})});Qt.displayName=ca;var Gt=Kt,Ut=Wt,oa=Qt;const tt=m.forwardRef(({className:u,...k},v)=>e.jsx(Gt,{className:$t("grid gap-2",u),...k,ref:v}));tt.displayName=Gt.displayName;const Fe=m.forwardRef(({className:u,...k},v)=>e.jsx(Ut,{ref:v,className:$t("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",u),...k,children:e.jsx(oa,{className:"flex items-center justify-center",children:e.jsx(Fs,{className:"h-2.5 w-2.5 fill-current text-current"})})}));Fe.displayName=Ut.displayName;const Ae=["oklch(var(--chart-1))","oklch(var(--chart-2))","oklch(var(--chart-3))","oklch(var(--chart-4))","oklch(var(--chart-5))"];function la(){var ot;const{user:u}=kt(),v=new URLSearchParams(window.location.search).get("tab"),[h,p]=m.useState(new Set),[L,w]=m.useState(v==="whatif"?"whatif":"realtime"),[f,$]=m.useState("actual"),[M,j]=m.useState(20),[P,W]=m.useState("openinsider"),[T,F]=m.useState(!1),[O,Q]=m.useState(null),[oe,pe]=m.useState("all_holdings"),[Ce,Se]=m.useState(""),[Le,Be]=m.useState(new Set),$e=m.useRef(!1),{toast:q}=wt(),{data:E}=U({queryKey:["/api/feature-flags"]}),{data:g,isLoading:Re}=U({queryKey:["/api/portfolio/holdings","simulated"],queryFn:async()=>{const t=await fetch("/api/portfolio/holdings?simulated=true");if(!t.ok)throw new Error("Failed to fetch holdings");return t.json()},refetchInterval:3e5,staleTime:0}),{data:C,isLoading:s}=U({queryKey:["/api/stocks"],refetchInterval:3e5,staleTime:0}),{data:d,isLoading:V}=U({queryKey:["/api/rules",u==null?void 0:u.id],refetchInterval:3e5,enabled:!!u,queryFn:async()=>{const t=await fetch("/api/rules",{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch rules");return t.json()}}),{data:S,isLoading:Z}=U({queryKey:["/api/trades","simulated"],queryFn:async()=>{const t=await fetch("/api/trades?simulated=true");if(!t.ok)throw new Error("Failed to fetch trades");return t.json()},refetchInterval:3e5}),{data:J,isLoading:fe}=U({queryKey:["/api/backtest/jobs"],refetchInterval:t=>(t.state.data||[]).some(r=>!["completed","failed"].includes(r.status))?5e3:!1}),{data:le}=U({queryKey:["/api/telegram/status"],enabled:(E==null?void 0:E.enableTelegram)??!1}),Te=J||[],[de,Jt]=m.useState(null),Oe=(E==null?void 0:E.enableTelegram)&&(le==null?void 0:le.isConnected)||!1,{data:Ve,isLoading:Yt}=U({queryKey:["/api/backtest/jobs",de,"scenarios"],enabled:!!de}),Ke=m.useMemo(()=>Ve?[...Ve].sort((t,i)=>parseFloat(i.totalProfitLoss)-parseFloat(t.totalProfitLoss)):[],[Ve]),{data:He,isLoading:Xt}=U({queryKey:["/api/backtest/jobs",de,"price-data"],enabled:!!de}),Ee=de?Te.find(t=>t.id===de):null,We=ne({mutationFn:async()=>{const t=await fetch("/api/backtest/jobs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messageCount:M,dataSource:P})});if(!t.ok){const i=await t.json();throw new Error(i.message||"Failed to launch backtest")}return t.json()},onSuccess:()=>{q({title:"Backtest launched",description:`Processing ${M} ${P==="telegram"?"Telegram messages":"SEC insider trading filings"} in the background...`}),X.invalidateQueries({queryKey:["/api/backtest/jobs"]})},onError:t=>{q({title:"Failed to launch backtest",description:t.message,variant:"destructive"})}}),Zt=()=>{if(E!=null&&E.enableTelegram&&P==="telegram"&&!Oe){q({title:"Telegram not connected",description:"Please connect to Telegram in Settings before running a backtest.",variant:"destructive"});return}We.mutate()},rt=ne({mutationFn:async t=>{const i=await fetch(`/api/backtest/jobs/${t}/cancel`,{method:"PATCH"});if(!i.ok){const a=await i.json();throw new Error(a.message||"Failed to cancel backtest")}return i.json()},onSuccess:()=>{q({title:"Backtest cancelled",description:"The job has been stopped."}),X.invalidateQueries({queryKey:["/api/backtest/jobs"]})},onError:t=>{q({title:"Failed to cancel backtest",description:t.message,variant:"destructive"})}}),es=t=>{rt.mutate(t)},nt=ne({mutationFn:async t=>{const i=await fetch(`/api/backtest/jobs/${t}`,{method:"DELETE"});if(!i.ok){const a=await i.json();throw new Error(a.message||"Failed to delete backtest")}return i.json()},onSuccess:()=>{q({title:"Backtest deleted",description:"The job has been removed."}),X.invalidateQueries({queryKey:["/api/backtest/jobs"]})},onError:t=>{q({title:"Failed to delete backtest",description:t.message,variant:"destructive"})}}),ts=t=>{nt.mutate(t)},_e=ne({mutationFn:async({scenarioId:t,scope:i,ticker:a})=>await Pe("POST",`/api/backtest/scenarios/${t}/import`,{scope:i,ticker:a}),onSuccess:()=>{q({title:"Scenario imported",description:"Trading rule created successfully. Check the Rules page to enable it."}),X.invalidateQueries({queryKey:["/api/rules",u==null?void 0:u.id]}),F(!1),Q(null),pe("all_holdings"),Se("")},onError:t=>{q({title:"Failed to import scenario",description:t.message,variant:"destructive"})}}),ct=ne({mutationFn:async t=>await Pe("DELETE",`/api/stocks/${t}/simulate`,null),onSuccess:(t,i)=>{q({title:"Simulation Removed",description:`Removed simulated position for ${i}`}),X.invalidateQueries({queryKey:["/api/portfolio/holdings","simulated"]}),X.invalidateQueries({queryKey:["/api/trades","simulated"]}),p(a=>{const r=new Set(a);return r.delete(i),r})},onError:()=>{q({title:"Failed to Remove",description:"Unable to remove simulation. Please try again.",variant:"destructive"})}}),ss=t=>{Q(t),pe("all_holdings"),Se(""),F(!0)},as=()=>{if(O){if(oe==="specific_stock"&&!Ce){q({title:"Select a ticker",description:"Please select a stock ticker for the rule.",variant:"destructive"});return}_e.mutate({scenarioId:O,scope:oe,ticker:oe==="specific_stock"?Ce:void 0})}},is=Re||s||V||Z,B=m.useMemo(()=>!g||!C?[]:g.map(t=>C.find(i=>i.ticker===t.ticker)).filter(t=>t!==void 0),[g,C]);m.useEffect(()=>{B.length>0&&!$e.current&&(p(new Set(B.map(t=>t.ticker))),$e.current=!0)},[B]);const rs=t=>{p(i=>{const a=new Set(i);return a.has(t)?a.delete(t):a.add(t),a})},ns=()=>{p(new Set(B.map(t=>t.ticker)))},cs=()=>{p(new Set)},ue=m.useMemo(()=>{if(!g||!C||!S||h.size===0)return[];const t=B.filter(l=>h.has(l.ticker)&&l.priceHistory);if(t.length===0)return[];const i=new Map;t.forEach(l=>{const N=S.filter(x=>x.ticker===l.ticker&&x.type==="buy"&&x.executedAt);if(N.length>0){const x=N.sort((D,z)=>new Date(D.executedAt).getTime()-new Date(z.executedAt).getTime())[0];x!=null&&x.executedAt&&i.set(l.ticker,new Date(x.executedAt))}});let a=null,r=null;if(i.forEach(l=>{(!a||l<a)&&(a=l)}),t.forEach(l=>{var N;(N=l.priceHistory)==null||N.forEach(x=>{const D=new Date(x.date);(!r||D>r)&&(r=D)})}),a||t.forEach(l=>{var N;(N=l.priceHistory)==null||N.forEach(x=>{const D=new Date(x.date);(!a||D<a)&&(a=D)})}),!a||!r)return[];new Date(a).setHours(0,0,0,0),new Date(r).setHours(0,0,0,0);const o=new Set;return t.forEach(l=>{var N;(N=l.priceHistory)==null||N.forEach(x=>{o.add(x.date)})}),Array.from(o).map(l=>({dateStr:l,date:new Date(l)})).filter(({date:l})=>l>=a&&l<=r).sort((l,N)=>l.date.getTime()-N.date.getTime()).map(({dateStr:l})=>l).map(l=>{const N={date:l},x=new Date(l);return t.forEach(D=>{var G;const z=i.get(D.ticker);if(!z||x>=z){const me=(G=D.priceHistory)==null?void 0:G.find(y=>y.date===l);me&&(N[D.ticker]=me.price)}}),N})},[g,C,S,B,h]),Qe=m.useMemo(()=>{if(ue.length===0||!B||!g||!S)return[];const t={},i={};B.forEach(r=>{if(!h.has(r.ticker))return;const n=g.find(o=>o.ticker===r.ticker);if(!n)return;i[r.ticker]=parseFloat(n.averagePurchasePrice);const c=S.filter(o=>o.ticker===r.ticker&&o.type==="buy"&&o.executedAt);if(c.length>0){const o=c.sort((b,l)=>new Date(b.executedAt).getTime()-new Date(l.executedAt).getTime())[0];o!=null&&o.executedAt&&(t[r.ticker]=new Date(o.executedAt))}if(!t[r.ticker]){for(const o of ue)if(o[r.ticker]!=null){t[r.ticker]=new Date(o.date);break}}});const a=new Map;return ue.forEach(r=>{const n=new Date(r.date);isNaN(n.getTime())||Object.keys(t).forEach(c=>{const o=t[c],b=Math.floor((n.getTime()-o.getTime())/(1e3*60*60*24));if(b>=0&&r[c]!=null&&i[c]){a.has(b)||a.set(b,{day:b});const l=b===0?0:(r[c]-i[c])/i[c]*100;a.get(b)[c]=l}})}),Array.from(a.values()).sort((r,n)=>r.day-n.day)},[ue,B,h,g,S]),os=m.useMemo(()=>{if(!g||!S||!B)return[];const t=[];return B.forEach((i,a)=>{if(!h.has(i.ticker))return;const r=S.filter(n=>n.ticker===i.ticker&&n.type==="buy"&&n.executedAt);if(r.length>0){const n=r.sort((c,o)=>new Date(c.executedAt).getTime()-new Date(o.executedAt).getTime())[0];if(n!=null&&n.executedAt){const c=new Date(n.executedAt),o=c.toISOString().split("T")[0];t.push({ticker:i.ticker,color:Ae[a%Ae.length],executedAt:c,dateString:o})}}}),t},[g,S,B,h]),Ge=f==="normalized"?Qe:ue,Ue=m.useMemo(()=>{if(!g||!C||!d)return[];const t=[];return g.forEach(i=>{const a=C.find(c=>c.ticker===i.ticker);if(!a||!h.has(a.ticker))return;const r=parseFloat(i.averagePurchasePrice);d.filter(c=>c.enabled&&(c.action==="sell"||c.action==="sell_all")&&(c.scope==="all_holdings"||c.scope==="specific_stock"&&c.ticker===a.ticker)).forEach(c=>{if(!c.conditions||c.conditions.length===0)return;const o=c.conditions[0];let b=0;o.metric==="price_change_percent"?b=r*(1+o.value/100):o.metric==="price_change_from_close_percent"?b=parseFloat(a.previousClose||a.currentPrice)*(1+o.value/100):o.metric==="price_absolute"&&(b=o.value);const l=o.operator==="<"||o.operator==="<=";t.push({ticker:a.ticker,rule:c,price:b,isLower:l})})}),t},[g,C,d,h]),Je=m.useMemo(()=>{if(!d||!g||!C)return[];const t=new Map;return g.forEach(i=>{const a=C.find(n=>n.ticker===i.ticker);if(!a||!h.has(a.ticker))return;d.filter(n=>n.enabled&&(n.action==="sell"||n.action==="sell_all")&&(n.scope==="all_holdings"||n.scope==="specific_stock"&&n.ticker===a.ticker)).forEach(n=>{if(!n.conditions||n.conditions.length===0)return;const c=n.conditions[0];if(c.metric==="price_change_percent"){const o=c.value,b=c.operator==="<"||c.operator==="<=",l=`${n.id}-${o}`;t.has(l)||t.set(l,{rule:n,percentage:o,isLower:b,name:n.name})}})}),Array.from(t.values())},[d,g,C,h]),ls=m.useMemo(()=>{if(f==="normalized"){const n=[];if(Qe.forEach(l=>{Object.keys(l).forEach(N=>{N!=="date"&&typeof l[N]=="number"&&n.push(l[N])})}),Je.forEach(l=>{n.push(l.percentage)}),n.length===0)return[-10,10];const c=Math.min(...n,0),o=Math.max(...n,0),b=Math.max(Math.abs(c),Math.abs(o))*.1||1;return[Math.floor(c-b),Math.ceil(o+b)]}const t=[];if(ue.forEach(n=>{Object.keys(n).forEach(c=>{c!=="date"&&typeof n[c]=="number"&&t.push(n[c])})}),Ue.forEach(n=>{t.push(n.price)}),g==null||g.forEach(n=>{h.has(n.ticker)&&t.push(parseFloat(n.averagePurchasePrice))}),t.length===0)return["auto","auto"];const i=Math.min(...t),a=Math.max(...t);let r=(a-i)*.1;return r===0&&(r=a*.01||1),[Math.floor(i-r),Math.ceil(a+r)]},[f,ue,Qe,Ue,Je,g,h]),_=m.useMemo(()=>{if(!g||!C||!S)return null;let t=0,i=0;g.forEach(x=>{const D=C.find(z=>z.ticker===x.ticker);if(D){const z=parseFloat(D.currentPrice),G=parseFloat(x.averagePurchasePrice);t+=z*x.quantity,i+=G*x.quantity}});const a=t-i,r=i>0?a/i*100:0,n=new Map;S.forEach(x=>{n.has(x.ticker)||n.set(x.ticker,{buys:[],sells:[]});const D=n.get(x.ticker);x.type==="buy"?D.buys.push(x):x.type==="sell"&&D.sells.push(x)});let c=0,o=0;n.forEach((x,D)=>{let z=0,G=0;x.buys.forEach(y=>{const K=y.quantity,ee=parseFloat(y.price);z+=K,G+=ee*K});const me=z>0?G/z:0;x.sells.forEach(y=>{const K=y.quantity,ge=parseFloat(y.price)*K,ds=me*K;c+=ge-ds}),o+=G});const b=a+c,l=o>0?o:i,N=l>0?b/l*100:0;return{totalValue:t,totalCost:i,unrealizedPL:a,unrealizedPLPercent:r,realizedPL:c,totalPL:b,totalPLPercent:isFinite(N)?N:0,isPositive:b>=0}},[g,C,S]);return is?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx(ce,{className:"h-8 w-48 mb-2"}),e.jsx(ce,{className:"h-4 w-96"})]}),e.jsxs(A,{children:[e.jsx(ie,{children:e.jsx(ce,{className:"h-6 w-32"})}),e.jsx(H,{children:e.jsx(ce,{className:"h-96 w-full"})})]})]}):!g||g.length===0?e.jsxs("div",{className:"p-6 space-y-6 max-w-screen-2xl mx-auto",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h1",{className:"text-xl font-semibold whitespace-nowrap","data-testid":"text-page-title",children:"Simulation"})}),e.jsx(A,{className:"p-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Us,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2","data-testid":"text-no-holdings",children:"No Simulated Holdings"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Create simulated trades from the Purchase page to track performance"})]})})]}):e.jsxs("div",{className:"p-6 space-y-6 max-w-screen-2xl mx-auto",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h1",{className:"text-xl font-semibold whitespace-nowrap","data-testid":"text-page-title",children:"Simulation"})}),e.jsxs(Rt,{value:L,onValueChange:t=>w(t),className:"space-y-6","data-testid":"tabs-simulation",children:[e.jsxs(Et,{children:[e.jsx(Me,{value:"realtime","data-testid":"tab-realtime",children:"Real-time"}),e.jsx(Me,{value:"whatif","data-testid":"tab-whatif",children:"What-if"})]}),e.jsxs(ze,{value:"realtime",className:"space-y-6",children:[_&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsx(A,{children:e.jsxs(H,{className:"pt-6",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Current Value"}),e.jsxs("div",{className:"text-2xl font-mono font-semibold","data-testid":"text-total-value",children:["$",_.totalValue.toFixed(2)]})]})}),e.jsx(A,{children:e.jsxs(H,{className:"pt-6",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Invested"}),e.jsxs("div",{className:"text-2xl font-mono font-semibold","data-testid":"text-total-cost",children:["$",_.totalCost.toFixed(2)]})]})}),e.jsx(A,{children:e.jsxs(H,{className:"pt-6",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Unrealized P&L"}),e.jsxs("div",{className:`text-2xl font-mono font-semibold ${_.unrealizedPL>=0?"text-success":"text-destructive"}`,"data-testid":"text-unrealized-pl",children:[_.unrealizedPL>=0?"+":"","$",_.unrealizedPL.toFixed(2)]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[_.unrealizedPL>=0?"+":"",_.unrealizedPLPercent.toFixed(2),"%"]})]})}),e.jsx(A,{children:e.jsxs(H,{className:"pt-6",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Realized P&L"}),e.jsxs("div",{className:`text-2xl font-mono font-semibold ${_.realizedPL>=0?"text-success":"text-destructive"}`,"data-testid":"text-realized-pl",children:[_.realizedPL>=0?"+":"","$",_.realizedPL.toFixed(2)]})]})}),e.jsx(A,{children:e.jsxs(H,{className:"pt-6",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Total P&L"}),e.jsxs("div",{className:`text-2xl font-mono font-semibold ${_.isPositive?"text-success":"text-destructive"}`,"data-testid":"text-total-pl",children:[_.isPositive?"+":"","$",_.totalPL.toFixed(2)]})]})}),e.jsx(A,{children:e.jsxs(H,{className:"pt-6",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Total Return"}),e.jsxs("div",{className:`text-2xl font-mono font-semibold ${_.isPositive?"text-success":"text-destructive"}`,"data-testid":"text-total-return",children:[_.isPositive?"+":"",_.totalPLPercent.toFixed(2),"%"]})]})})]}),e.jsxs(A,{"data-testid":"card-unified-chart",children:[e.jsxs(ie,{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-row items-center justify-between gap-2 flex-wrap",children:[e.jsxs("div",{children:[e.jsx(xe,{children:"Simulated Price History"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:f==="normalized"?"Percentage change from initial price":"Stock prices updated every 5 minutes"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1 border rounded-md p-1",children:[e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(R,{variant:f==="actual"?"default":"ghost",size:"lg",onClick:()=>$("actual"),"data-testid":"toggle-view-mode-actual",className:"toggle-elevate",children:"Actual"})}),e.jsx(mt,{children:e.jsx("p",{children:"View actual dollar values of stock prices"})})]}),e.jsxs(dt,{children:[e.jsx(ut,{asChild:!0,children:e.jsx(R,{variant:f==="normalized"?"default":"ghost",size:"lg",onClick:()=>$("normalized"),"data-testid":"toggle-view-mode-normalized",className:"toggle-elevate",children:"Normalized"})}),e.jsx(mt,{children:e.jsx("p",{children:"View percentage change from your purchase price"})})]})]}),e.jsx(R,{variant:"outline",size:"lg",onClick:ns,"data-testid":"button-select-all",children:"Select All"}),e.jsx(R,{variant:"outline",size:"lg",onClick:cs,"data-testid":"button-deselect-all",children:"Clear All"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-xs text-muted-foreground mr-1",children:"Filter:"}),B.map(t=>{const i=h.has(t.ticker);return e.jsx(Y,{variant:i?"default":"outline",className:"cursor-pointer hover-elevate",onClick:()=>rs(t.ticker),"data-testid":`badge-filter-${t.ticker}`,children:t.ticker},t.ticker)})]})]}),e.jsx(H,{children:e.jsx("div",{className:"h-[500px] w-full","data-testid":"chart-unified",children:e.jsx(ft,{width:"100%",height:"100%",children:e.jsxs(gt,{data:Ge,margin:{top:30,right:80,left:20,bottom:20},children:[e.jsx(pt,{strokeDasharray:"3 3",stroke:"oklch(var(--border))"}),e.jsx(jt,{dataKey:f==="normalized"?"day":"date",stroke:"oklch(var(--muted-foreground))",fontSize:12,tickFormatter:t=>{if(f==="normalized")return`Day ${t}`;const i=new Date(t);return`${i.getMonth()+1}/${i.getDate()}`}}),e.jsx(vt,{stroke:"oklch(var(--muted-foreground))",fontSize:12,domain:ls,tickFormatter:t=>f==="normalized"?`${t.toFixed(0)}%`:`$${t.toFixed(0)}`}),f==="normalized"&&e.jsx(he,{y:0,stroke:"oklch(var(--muted-foreground))",strokeDasharray:"5 5",strokeWidth:1.5}),f==="actual"&&os.map(t=>e.jsx(he,{x:t.dateString,stroke:t.color,strokeDasharray:"3 3",strokeWidth:2,label:{value:`${t.ticker} Buy`,position:"top",fill:t.color,fontSize:11,fontWeight:600},"data-testid":`purchase-marker-${t.ticker}`},t.ticker)),f==="normalized"&&e.jsx(he,{x:0,stroke:"oklch(var(--primary))",strokeDasharray:"3 3",strokeWidth:2,label:{value:"Purchase",position:"top",fill:"oklch(var(--primary))",fontSize:11,fontWeight:600},"data-testid":"purchase-marker-normalized"}),e.jsx(bt,{contentStyle:{backgroundColor:"oklch(var(--popover))",border:"1px solid oklch(var(--border))",borderRadius:"6px"},labelStyle:{color:"oklch(var(--popover-foreground))"},formatter:(t,i)=>[f==="normalized"?`${t.toFixed(2)}%`:`$${t.toFixed(2)}`,i],labelFormatter:t=>f==="normalized"?`Day ${t}`:`Date: ${t}`}),e.jsx(Ws,{wrapperStyle:{paddingTop:"20px"},iconType:"line",formatter:t=>e.jsx("span",{style:{color:"oklch(var(--foreground))",fontSize:"12px",fontWeight:600},children:t})}),B.filter(t=>h.has(t.ticker)).map((t,i)=>{const a=Ae[i%Ae.length];return e.jsx(yt,{type:"monotone",dataKey:t.ticker,stroke:a,strokeWidth:2,dot:!1,name:t.ticker,children:e.jsx(Qs,{dataKey:t.ticker,position:"right",content:({x:r,y:n,value:c,index:o})=>o===void 0||!Ge[o]||!(o===Ge.length-1)?null:e.jsx("text",{x:Number(r)+10,y:Number(n),fill:a,fontSize:12,fontWeight:600,textAnchor:"start",children:t.ticker})})},t.ticker)}),f==="actual"&&Ue.map((t,i)=>{const a=t.isLower?"oklch(var(--destructive))":"oklch(var(--success))",r=t.isLower?"Stop Loss":"Take Profit";return e.jsx(he,{y:t.price,stroke:a,strokeWidth:2,strokeDasharray:"5 5",label:{value:`${t.ticker} ${r}: $${t.price.toFixed(2)}`,position:t.isLower?"insideBottomLeft":"insideTopLeft",fill:a,fontSize:11,fontWeight:"600"}},`rule-${t.ticker}-${t.rule.id}-${i}`)}),f==="actual"&&(g==null?void 0:g.filter(t=>h.has(t.ticker)).map(t=>{const i=parseFloat(t.averagePurchasePrice);return e.jsx(he,{y:i,stroke:"oklch(var(--muted-foreground))",strokeWidth:2,strokeDasharray:"3 3",label:{value:`${t.ticker} Purchase: $${i.toFixed(2)}`,position:"insideTopLeft",fill:"oklch(var(--muted-foreground))",fontSize:11,fontWeight:"500"}},`purchase-${t.ticker}`)})),f==="normalized"&&Je.map((t,i)=>{const a=t.isLower?"oklch(var(--destructive))":"oklch(var(--success))",r=t.isLower?"Stop Loss":"Take Profit";return e.jsx(he,{y:t.percentage,stroke:a,strokeWidth:2,strokeDasharray:"5 5",label:{value:`${r}: ${t.percentage>=0?"+":""}${t.percentage.toFixed(1)}%`,position:t.isLower?"insideBottomLeft":"insideTopLeft",fill:a,fontSize:11,fontWeight:"600"}},`rule-norm-${t.rule.id}-${i}`)})]})})})})]}),e.jsxs(A,{"data-testid":"card-holdings-summary",children:[e.jsx(ie,{children:e.jsx(xe,{children:"Holdings Details"})}),e.jsx(H,{children:e.jsx("div",{className:"space-y-4",children:g.map(t=>{const i=C==null?void 0:C.find(b=>b.ticker===t.ticker);if(!i)return null;const a=parseFloat(i.currentPrice),r=parseFloat(t.averagePurchasePrice),n=a-r,c=n/r*100,o=n>=0;return e.jsxs("div",{className:"border rounded-lg p-4","data-testid":`holding-${i.ticker}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"text-lg font-semibold","data-testid":`text-ticker-${i.ticker}`,children:i.ticker}),e.jsxs(Y,{variant:o?"default":"destructive",className:"text-xs","data-testid":`badge-performance-${i.ticker}`,children:[o?e.jsx(Xe,{className:"h-3 w-3 mr-1"}):e.jsx(Nt,{className:"h-3 w-3 mr-1"}),o?"+":"",c.toFixed(2),"%"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground","data-testid":`text-company-${i.ticker}`,children:i.companyName})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Holding"}),e.jsxs("div",{className:"text-lg font-mono font-semibold","data-testid":`text-quantity-${i.ticker}`,children:[t.quantity," shares"]})]}),e.jsx(R,{variant:"ghost",size:"icon",onClick:()=>ct.mutate(i.ticker),disabled:ct.isPending,"data-testid":`button-remove-${i.ticker}`,className:"h-11 w-11",children:e.jsx(Ze,{className:"h-4 w-4 text-destructive"})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm mt-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Purchase"}),e.jsxs("p",{className:"font-mono font-medium","data-testid":`text-purchase-${i.ticker}`,children:["$",r.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Current"}),e.jsxs("p",{className:"font-mono font-medium","data-testid":`text-current-${i.ticker}`,children:["$",a.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"P&L"}),e.jsxs("p",{className:`font-mono font-medium ${o?"text-success":"text-destructive"}`,"data-testid":`text-pl-${i.ticker}`,children:[o?"+":"","$",n.toFixed(2)]})]})]})]},t.id)})})})]})]}),e.jsxs(ze,{value:"whatif",className:"space-y-6",children:[e.jsxs(A,{children:[e.jsxs(ie,{children:[e.jsx(xe,{children:"Launch What-If Backtest"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Analyze historical insider trading data with AI-powered trading scenarios"})]}),e.jsx(H,{children:e.jsxs("div",{className:"space-y-4",children:[(E==null?void 0:E.enableTelegram)&&!Oe&&P==="telegram"&&e.jsxs("div",{className:"flex items-start gap-3 p-4 border border-destructive/50 bg-destructive/10 rounded-md",children:[e.jsx(Gs,{className:"h-5 w-5 text-destructive mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-destructive",children:"Telegram Not Connected"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Please connect to Telegram in Settings to enable backtesting. The backtest feature requires access to your Telegram channel to fetch historical messages."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{"data-testid":"label-data-source",children:"Data Source"}),e.jsxs(tt,{value:P,onValueChange:t=>W(t),"data-testid":"radio-data-source",children:[(E==null?void 0:E.enableTelegram)&&e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Fe,{value:"telegram",id:"telegram","data-testid":"radio-telegram"}),e.jsx(re,{htmlFor:"telegram",className:"font-normal cursor-pointer",children:"Telegram Channel"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Fe,{value:"openinsider",id:"openinsider","data-testid":"radio-openinsider"}),e.jsx(re,{htmlFor:"openinsider",className:"font-normal cursor-pointer",children:"SEC Insider Trading Filings"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:P==="telegram"?"Analyze historical messages from configured Telegram channel":"Analyze latest insider trading transactions from SEC regulatory filings"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{htmlFor:"messageCount","data-testid":"label-message-count",children:P==="telegram"?"Number of Messages":"Number of Transactions"}),e.jsx(De,{id:"messageCount",type:"number",min:"1",max:"2000",defaultValue:"20",placeholder:"20",onChange:t=>j(parseInt(t.target.value)||20),"data-testid":"input-message-count"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:P==="telegram"?"Fetch and analyze the last N Telegram messages (max 2000)":"Fetch and analyze the last N insider trades (max 2000)"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(R,{className:"w-full md:w-auto",onClick:Zt,disabled:We.isPending||P==="telegram"&&!Oe,"data-testid":"button-launch-backtest",children:[We.isPending?e.jsx(be,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(_t,{className:"h-4 w-4 mr-2"}),"Launch Backtest"]})})]})]}),e.jsxs("div",{className:"pt-4 border-t",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"How it works:"}),e.jsxs("ol",{className:"text-sm text-muted-foreground space-y-1 list-decimal list-inside",children:[e.jsx("li",{children:P==="telegram"?"Fetches the last N messages from Telegram channel":"Fetches the last N insider purchase transactions from SEC regulatory filings"}),e.jsx("li",{children:"Filters purchase candidates (market cap > $100M, valid insider trades)"}),e.jsx("li",{children:"Builds price matrix (1 month before to today)"}),e.jsx("li",{children:"OpenAI generates 10 trading rule scenarios"}),e.jsx("li",{children:"Calculates P&L for each scenario"})]})]})]})})]}),e.jsxs(A,{children:[e.jsx(ie,{children:e.jsx(xe,{children:"Backtest Jobs"})}),e.jsx(H,{children:fe?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(be,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):Te.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8","data-testid":"text-no-jobs",children:"No backtest jobs yet. Launch one above to get started."}):e.jsx("div",{className:"space-y-2",children:Te.map(t=>{var r;const i={pending:"Queued",fetching_messages:"Fetching Messages",filtering:"Filtering Candidates",building_matrix:"Building Price Matrix",generating_scenarios:"Generating AI Scenarios",calculating_results:"Calculating P&L",completed:"Completed",failed:"Failed",cancelled:"Cancelled"},a=!["completed","failed","cancelled"].includes(t.status);return e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-md hover-elevate cursor-pointer",onClick:()=>t.status==="completed"&&Jt(t.id),"data-testid":`card-backtest-job-${t.id}`,children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[a?e.jsx(be,{className:"h-5 w-5 text-primary animate-spin"}):t.status==="completed"?e.jsx("div",{className:"h-5 w-5 rounded-full bg-success/20 flex items-center justify-center",children:e.jsx("div",{className:"h-2 w-2 rounded-full bg-success"})}):e.jsx("div",{className:"h-5 w-5 rounded-full bg-destructive/20 flex items-center justify-center",children:e.jsx("div",{className:"h-2 w-2 rounded-full bg-destructive"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Backtest ",new Date(t.createdAt).toLocaleString()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.messageCount," messages • ",i[t.status]||t.status,a&&` • ${t.progress}%`]}),((r=t.metadata)==null?void 0:r.candidateStocks)&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[t.metadata.candidateStocks.length," candidate stocks found"]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:a?e.jsxs(e.Fragment,{children:[e.jsxs(Y,{variant:"outline",children:[e.jsx($s,{className:"h-3 w-3 mr-1"}),t.progress,"%"]}),e.jsx(R,{variant:"ghost",size:"lg",onClick:()=>es(t.id),disabled:rt.isPending,"data-testid":`button-cancel-${t.id}`,children:e.jsx(ht,{className:"h-4 w-4"})})]}):e.jsxs(e.Fragment,{children:[t.status==="completed"?e.jsxs(Y,{variant:"default",className:"bg-success hover:bg-success",children:[e.jsx(Rs,{className:"h-3 w-3 mr-1"}),"Done"]}):t.status==="cancelled"?e.jsxs(Y,{variant:"outline",children:[e.jsx(ht,{className:"h-3 w-3 mr-1"}),"Cancelled"]}):e.jsx(Y,{variant:"destructive",children:"Failed"}),e.jsx(R,{variant:"ghost",size:"lg",onClick:()=>ts(t.id),disabled:nt.isPending,"data-testid":`button-delete-${t.id}`,children:e.jsx(Ze,{className:"h-4 w-4"})})]})})]},t.id)})})})]}),de&&Ee&&e.jsxs(e.Fragment,{children:[e.jsxs(A,{children:[e.jsxs(ie,{children:[e.jsx(xe,{children:"Backtest Stocks & Historical Prices"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[((ot=Ee.candidateStocks)==null?void 0:ot.length)||0," candidate stocks analyzed from ",Ee.messageCount," messages"]})]}),e.jsx(H,{children:Xt?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(be,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):!He||He.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No price data available for this job."}):e.jsx("div",{className:"space-y-6",children:He.map(t=>{var N,x,D,z,G,me;const i=(N=Ee.candidateStocks)==null?void 0:N.find(y=>y.ticker===t.ticker),a=new Date(t.insiderBuyDate),r=t.priceMatrix.map(y=>{const K=new Date(y.date);return{date:y.date,dateLabel:`${K.getMonth()+1}/${K.getDate()}`,price:y.close,isInsiderBuy:y.date===t.insiderBuyDate}}),n=((x=r.find(y=>y.isInsiderBuy))==null?void 0:x.price)||((D=r[0])==null?void 0:D.price),c=(z=r[r.length-1])==null?void 0:z.price,o=c&&n?c-n:0,b=n?o/n*100:0,l=o>=0;return e.jsxs("div",{className:"border rounded-lg p-4 space-y-4","data-testid":`stock-price-${t.ticker}`,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-lg",children:t.ticker}),e.jsxs(Y,{variant:"outline",children:[r.length," days"]})]}),n&&c&&e.jsxs(Y,{variant:l?"default":"destructive",className:"text-xs","data-testid":`badge-price-change-${t.ticker}`,children:[l?e.jsx(Xe,{className:"h-3 w-3 mr-1"}):e.jsx(Nt,{className:"h-3 w-3 mr-1"}),l?"+":"",b.toFixed(2),"%"]})]}),i&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4 p-3 bg-muted/50 rounded-md",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Market Cap"}),e.jsx("p",{className:"text-sm font-medium",children:i.marketCap})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Purchase Date"}),e.jsx("p",{className:"text-sm font-medium",children:a.toLocaleDateString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Insider Price"}),e.jsxs("p",{className:"text-sm font-medium font-mono",children:["$",(G=i.insiderPrice)==null?void 0:G.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Entry Price"}),e.jsxs("p",{className:"text-sm font-medium font-mono",children:["$",n==null?void 0:n.toFixed(2)]})]}),c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Latest Price"}),e.jsxs("p",{className:`text-sm font-medium font-mono ${l?"text-success":"text-destructive"}`,children:["$",c.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"P&L"}),e.jsxs("p",{className:`text-sm font-medium font-mono ${l?"text-success":"text-destructive"}`,children:[l?"+":"","$",o.toFixed(2)]})]})]})]}),e.jsx("div",{className:"h-64",children:e.jsx(ft,{width:"100%",height:"100%",children:e.jsxs(gt,{data:r,children:[e.jsx(pt,{strokeDasharray:"3 3",stroke:"oklch(var(--border))"}),e.jsx(jt,{dataKey:"dateLabel",tick:{fontSize:11},stroke:"oklch(var(--muted-foreground))"}),e.jsx(vt,{domain:["auto","auto"],tick:{fontSize:11},stroke:"oklch(var(--muted-foreground))",tickFormatter:y=>`$${y.toFixed(2)}`}),e.jsx(bt,{contentStyle:{backgroundColor:"oklch(var(--card))",border:"1px solid oklch(var(--border))",borderRadius:"0.5rem"},formatter:y=>[`$${y.toFixed(2)}`,"Price"],labelFormatter:(y,K)=>{var ge;const ee=(ge=K[0])==null?void 0:ge.payload;return`${y}${ee!=null&&ee.isInsiderBuy?" (Your Entry)":""}`}}),e.jsx(yt,{type:"monotone",dataKey:"price",stroke:"oklch(var(--chart-1))",strokeWidth:2,dot:y=>{const{cx:K,cy:ee,payload:ge}=y;return ge.isInsiderBuy?e.jsx("circle",{cx:K,cy:ee,r:6,fill:"oklch(var(--primary))",stroke:"oklch(var(--background))",strokeWidth:2}):e.jsx("circle",{cx:K,cy:ee,r:2,fill:"oklch(var(--chart-1))"})}}),r.find(y=>y.isInsiderBuy)&&e.jsx(he,{x:(me=r.find(y=>y.isInsiderBuy))==null?void 0:me.dateLabel,stroke:"oklch(var(--primary))",strokeWidth:2,strokeDasharray:"5 5",label:{value:"Your Purchase",position:"top",fill:"oklch(var(--primary))",fontSize:11,fontWeight:"600"}})]})})})]},t.ticker)})})})]}),e.jsxs(A,{children:[e.jsxs(ie,{children:[e.jsx(xe,{children:"Top 10 Scenario Results"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Showing the best 10 strategies out of 100 AI-generated scenarios, sorted by total P&L"})]}),e.jsx(H,{children:Yt?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(be,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):!Ke||Ke.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"No scenarios found for this job."}):e.jsx("div",{className:"space-y-4",children:Ke.map((t,i)=>e.jsxs("div",{className:"border rounded-md p-4 space-y-3","data-testid":`card-scenario-${t.scenarioNumber}`,children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-medium",children:t.name}),i===0&&parseFloat(t.totalProfitLoss)>0&&e.jsxs(Y,{variant:"default",className:"text-xs","data-testid":"badge-winning-strategy",children:[e.jsx(Xe,{className:"h-3 w-3 mr-1"}),"Winning Strategy"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:t.description})]}),e.jsxs(R,{size:"lg",variant:"outline",onClick:()=>ss(t.id),"data-testid":`button-import-scenario-${t.scenarioNumber}`,children:[e.jsx(qs,{className:"h-3 w-3 mr-1"}),"Import"]})]}),e.jsxs("div",{className:"flex items-center gap-6 p-3 bg-muted/50 rounded-md",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total P&L"}),e.jsxs("p",{className:`text-lg font-mono font-bold ${parseFloat(t.totalProfitLoss)>=0?"text-success":"text-destructive"}`,"data-testid":`text-pnl-${t.scenarioNumber}`,children:[parseFloat(t.totalProfitLoss)>=0?"+":"","$",parseFloat(t.totalProfitLoss).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Return %"}),e.jsxs("p",{className:`text-lg font-mono font-bold ${parseFloat(t.totalProfitLossPercent)>=0?"text-success":"text-destructive"}`,children:[parseFloat(t.totalProfitLossPercent)>=0?"+":"",parseFloat(t.totalProfitLossPercent).toFixed(2),"%"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Win Rate"}),e.jsxs("p",{className:"text-lg font-medium",children:[parseFloat(t.winRate||0).toFixed(0),"%"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Trades"}),e.jsx("p",{className:"text-lg font-medium",children:t.numberOfTrades})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Sell Conditions:"}),e.jsx("div",{className:"space-y-2",children:t.sellConditions&&t.sellConditions.map((a,r)=>e.jsxs("div",{className:"text-sm text-muted-foreground flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"font-mono text-xs px-2 py-0.5 bg-muted rounded",children:[a.metric.replace(/_/g," ")," ",a.operator," ",a.value]}),a.logic&&r<t.sellConditions.length-1&&e.jsx("span",{className:"text-xs font-medium text-primary",children:a.logic})]},r))})]}),t.tradeDetails&&t.tradeDetails.length>0&&e.jsxs(Vs,{open:Le.has(t.id),onOpenChange:a=>{const r=new Set(Le);a?r.add(t.id):r.delete(t.id),Be(r)},children:[e.jsx(Ks,{asChild:!0,children:e.jsxs(R,{variant:"ghost",size:"lg",className:"w-full mt-2 justify-between","data-testid":`button-toggle-trades-${t.scenarioNumber}`,children:[e.jsxs("span",{className:"text-xs font-medium",children:["View Individual Trades (",t.tradeDetails.length,")"]}),Le.has(t.id)?e.jsx(Ms,{className:"h-3 w-3"}):e.jsx(zs,{className:"h-3 w-3"})]})}),e.jsx(Hs,{className:"mt-2 space-y-2",children:e.jsx("div",{className:"border rounded-md overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-1 text-left font-medium",children:"Ticker"}),e.jsx("th",{className:"px-2 py-1 text-left font-medium",children:"Buy Date"}),e.jsx("th",{className:"px-2 py-1 text-right font-medium",children:"Buy Price"}),e.jsx("th",{className:"px-2 py-1 text-left font-medium",children:"Sell Date"}),e.jsx("th",{className:"px-2 py-1 text-right font-medium",children:"Sell Price"}),e.jsx("th",{className:"px-2 py-1 text-right font-medium",children:"P&L"}),e.jsx("th",{className:"px-2 py-1 text-right font-medium",children:"Return %"}),e.jsx("th",{className:"px-2 py-1 text-left font-medium",children:"Sell Reason"})]})}),e.jsx("tbody",{children:t.tradeDetails.map((a,r)=>e.jsxs("tr",{className:"border-t","data-testid":`trade-row-${t.scenarioNumber}-${r}`,children:[e.jsx("td",{className:"px-2 py-1.5 font-medium",children:a.ticker}),e.jsx("td",{className:"px-2 py-1.5 text-muted-foreground",children:new Date(a.buyDate).toLocaleDateString()}),e.jsxs("td",{className:"px-2 py-1.5 text-right font-mono",children:["$",a.buyPrice.toFixed(2)]}),e.jsx("td",{className:"px-2 py-1.5 text-muted-foreground",children:new Date(a.sellDate).toLocaleDateString()}),e.jsxs("td",{className:"px-2 py-1.5 text-right font-mono",children:["$",a.sellPrice.toFixed(2)]}),e.jsxs("td",{className:`px-2 py-1.5 text-right font-mono font-medium ${a.profitLoss>=0?"text-success":"text-destructive"}`,children:[a.profitLoss>=0?"+":"","$",a.profitLoss.toFixed(2)]}),e.jsxs("td",{className:`px-2 py-1.5 text-right font-mono ${a.profitLossPercent>=0?"text-success":"text-destructive"}`,children:[a.profitLossPercent>=0?"+":"",a.profitLossPercent.toFixed(2),"%"]}),e.jsx("td",{className:"px-2 py-1.5 text-muted-foreground text-xs","data-testid":`text-reason-${t.scenarioNumber}-${r}`,children:a.reason||"N/A"})]},r))})]})})})]})]},t.id))})})]})]})]})]}),e.jsx(Pt,{open:T,onOpenChange:F,children:e.jsxs(Ct,{children:[e.jsxs(St,{children:[e.jsx(Lt,{children:"Import Scenario as Trading Rule"}),e.jsx(Tt,{children:"Choose whether to apply this rule to all holdings or a specific stock."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs(tt,{value:oe,onValueChange:t=>pe(t),children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Fe,{value:"all_holdings",id:"all_holdings","data-testid":"radio-all-holdings"}),e.jsx(re,{htmlFor:"all_holdings",className:"cursor-pointer",children:"Apply to all holdings"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Fe,{value:"specific_stock",id:"specific_stock","data-testid":"radio-specific-stock"}),e.jsx(re,{htmlFor:"specific_stock",className:"cursor-pointer",children:"Apply to specific stock"})]})]}),oe==="specific_stock"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(re,{htmlFor:"ticker-select",children:"Select Stock"}),e.jsxs(ye,{value:Ce,onValueChange:Se,children:[e.jsx(Ne,{id:"ticker-select","data-testid":"select-ticker",children:e.jsx(ke,{placeholder:"Choose a stock..."})}),e.jsx(we,{children:C==null?void 0:C.map(t=>e.jsx(I,{value:t.ticker,children:t.ticker},t.ticker))})]})]})]}),e.jsxs(Es,{children:[e.jsx(R,{variant:"outline",onClick:()=>F(!1),disabled:_e.isPending,"data-testid":"button-cancel-import",children:"Cancel"}),e.jsx(R,{onClick:as,disabled:_e.isPending,"data-testid":"button-confirm-import",children:_e.isPending?e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"h-3 w-3 mr-2 animate-spin"}),"Importing..."]}):"Import Rule"})]})]})})]})}function ka(){const[,u]=_s(),v=new URLSearchParams(window.location.search).get("tab")||"rules",[h,p]=m.useState(v);m.useEffect(()=>{const w=()=>{const $=new URLSearchParams(window.location.search).get("tab")||"rules";p($)};return window.addEventListener("popstate",w),window.addEventListener("urlchange",w),()=>{window.removeEventListener("popstate",w),window.removeEventListener("urlchange",w)}},[]);const L=w=>{p(w),u(`/trading?tab=${w}`),window.dispatchEvent(new Event("urlchange"))};return e.jsxs("div",{className:"p-4 md:p-6 space-y-4 md:space-y-6 max-w-7xl",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("h1",{className:"text-xl font-semibold whitespace-nowrap","data-testid":"text-page-title",children:"Trading"})}),e.jsxs(Rt,{value:h,onValueChange:L,className:"space-y-4 md:space-y-6",children:[e.jsxs(Et,{className:"w-full grid grid-cols-2","data-testid":"tabs-trading",children:[e.jsx(Me,{value:"rules","data-testid":"tab-rules",title:"Create automated rules to trigger actions based on stock price changes",children:"Trading Rules"}),e.jsx(Me,{value:"simulation","data-testid":"tab-simulation",title:"Simulate how your holdings would perform using historical price data",children:"Backtesting"})]}),e.jsx(ze,{value:"rules",forceMount:!0,hidden:h!=="rules",children:e.jsx(Xs,{})}),e.jsx(ze,{value:"simulation",forceMount:!0,hidden:h!=="simulation",children:e.jsx(la,{})})]})]})}export{ka as default};
