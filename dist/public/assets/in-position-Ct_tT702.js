import{d as Y,a as O,Y as G,r as l,u as q,e as V,j as e,w as W,x as J,B as i,a4 as X,y as Z,a0 as P,T as D,W as _,C as ee,h as se,G as te,D as ae,l as re,m as ne,n as ie,o as oe,a5 as ce,q as v,b as le}from"./index-DI4YInPS.js";import{S as C}from"./skeleton-DV0SbO6m.js";import{T as xe,a as de,b as L,c as x,d as pe,e as d}from"./table-Dh8obmbd.js";import{T as A}from"./trending-down-DrlS2k3i.js";import{S as me}from"./search-DL_GMNbq.js";import{B as z}from"./briefcase-C7pZccv6.js";import{A as he}from"./arrow-right-CkzTyZ9i.js";import{A as ue}from"./arrow-up-down-DSsJmQNo.js";import{A as je,a as ge}from"./arrow-up-DPXP0D04.js";function Te(){const{toast:$}=Y(),{user:b}=O(),[,U]=G(),[g,B]=l.useState(""),[f,H]=l.useState("pnl"),[j,T]=l.useState("desc"),[c,N]=l.useState({open:!1,holding:null}),{data:S=[],isLoading:I}=q({queryKey:["/api/portfolio/holdings"],enabled:!!b}),{data:k=[]}=q({queryKey:["/api/followed-stocks-with-status"],enabled:!!b}),F=V({mutationFn:async({holdingId:s,closePrice:t})=>await le("POST",`/api/portfolio/holdings/${s}/close`,{closePrice:t}),onSuccess:()=>{v.invalidateQueries({queryKey:["/api/portfolio/holdings"]}),v.invalidateQueries({queryKey:["/api/positions/count"]}),v.invalidateQueries({queryKey:["/api/portfolio/total-pnl"]}),N({open:!1,holding:null}),$({title:"Position Closed",description:"Your position has been closed and P&L recorded"})}}),p=l.useMemo(()=>S.filter(s=>s.quantity>0&&!s.isSimulated),[S]),w=l.useMemo(()=>{if(!g.trim())return p;const s=g.toUpperCase();return p.filter(t=>t.ticker.toUpperCase().includes(s))},[p,g]),M=s=>k.find(t=>t.ticker.toUpperCase()===s.toUpperCase()),m=s=>{const t=M(s.ticker);if(!t)return{pnl:0,pnlPercent:0,currentPrice:0};const n=parseFloat(t.currentPrice),o=parseFloat(s.averagePurchasePrice),r=(n-o)*s.quantity,a=(n-o)/o*100;return{pnl:r,pnlPercent:a,currentPrice:n}},h=s=>{f===s?T(j==="asc"?"desc":"asc"):(H(s),T(s==="ticker"?"asc":"desc"))},u=({field:s})=>f!==s?e.jsx(ue,{className:"h-4 w-4 ml-1"}):j==="asc"?e.jsx(je,{className:"h-4 w-4 ml-1"}):e.jsx(ge,{className:"h-4 w-4 ml-1"}),E=l.useMemo(()=>[...w].sort((s,t)=>{const n=m(s),o=m(t);let r,a;switch(f){case"ticker":r=s.ticker,a=t.ticker;break;case"entry":r=parseFloat(s.averagePurchasePrice),a=parseFloat(t.averagePurchasePrice);break;case"current":r=n.currentPrice,a=o.currentPrice;break;case"qty":r=s.quantity,a=t.quantity;break;case"pnl":r=n.pnl,a=o.pnl;break;case"pnlPercent":r=n.pnlPercent,a=o.pnlPercent;break;default:return 0}return r<a?j==="asc"?-1:1:r>a?j==="asc"?1:-1:0}),[w,k,f,j]),y=l.useMemo(()=>w.reduce((s,t)=>{const{pnl:n}=m(t);return s+n},0),[w,k]),K=s=>{N({open:!0,holding:s})},Q=()=>{if(c.holding){const{currentPrice:s}=m(c.holding);F.mutate({holdingId:c.holding.id,closePrice:s})}};return I?e.jsxs("div",{className:"p-4 md:p-6 space-y-4",children:[e.jsx(C,{className:"h-16 w-full"}),e.jsx(C,{className:"h-10 w-full"}),e.jsx(C,{className:"h-[400px] w-full"})]}):e.jsxs("div",{className:"p-4 md:p-6 space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-xl font-semibold whitespace-nowrap","data-testid":"text-page-title",children:"In Position"}),e.jsxs(W,{children:[e.jsx(J,{asChild:!0,children:e.jsx(i,{variant:"ghost",size:"icon",className:"h-6 w-6",tabIndex:0,"aria-label":"Learn how positions work","data-testid":"button-help-positions",children:e.jsx(X,{className:"h-4 w-4 text-muted-foreground"})})}),e.jsxs(Z,{side:"bottom",className:"max-w-sm p-4 space-y-3 text-left",children:[e.jsx("p",{className:"font-semibold text-sm",children:"Active Positions"}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Entry Price:"})," Your average purchase price"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Current Price:"})," Live market price"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"P&L:"})," Profit or loss on your position"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Close:"})," Close position and record P&L"]})]})]})]}),e.jsxs("span",{className:"text-sm text-muted-foreground ml-2","data-testid":"text-positions-count",children:["(",p.length,")"]}),p.length>0&&e.jsxs("span",{className:P("text-sm font-medium flex items-center gap-0.5 ml-2",y>=0?"text-success":"text-destructive"),children:[y>=0?e.jsx(D,{className:"h-3 w-3"}):e.jsx(A,{className:"h-3 w-3"}),y>=0?"+":"","$",y.toFixed(2)]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(me,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground"}),e.jsx(_,{placeholder:"Search...",value:g,onChange:s=>B(s.target.value),className:"pl-8 h-8 w-32 text-sm","data-testid":"input-search-positions"})]})]}),p.length===0?e.jsx(ee,{className:"bg-notebook-page",children:e.jsxs(se,{className:"p-8 text-center",children:[e.jsx(z,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No active positions"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Enter positions from stocks you're following to start tracking your trades."}),e.jsx(te,{href:"/following",children:e.jsxs(i,{"data-testid":"button-go-to-following",children:["View Following",e.jsx(he,{className:"h-4 w-4 ml-2"})]})})]})}):e.jsx("div",{className:"rounded-md border max-h-[calc(100vh-16rem)] overflow-hidden flex flex-col",children:e.jsx("div",{className:"overflow-x-auto overflow-y-auto flex-1",children:e.jsxs(xe,{className:"text-xs",children:[e.jsx(de,{className:"sticky top-0 bg-background z-[1]",children:e.jsxs(L,{children:[e.jsx(x,{className:"min-w-[60px] px-0.5 sm:px-1",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>h("ticker"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-ticker",children:["Ticker",e.jsx(u,{field:"ticker"})]})}),e.jsx(x,{className:"text-right min-w-[55px] px-0.5 sm:px-1",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>h("entry"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-entry",children:["Entry",e.jsx(u,{field:"entry"})]})}),e.jsx(x,{className:"text-right min-w-[55px] px-0.5 sm:px-1",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>h("current"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-current",children:[e.jsx("span",{className:"hidden sm:inline",children:"Current"}),e.jsx("span",{className:"sm:hidden",children:"Now"}),e.jsx(u,{field:"current"})]})}),e.jsx(x,{className:"text-right hidden sm:table-cell min-w-[40px] px-0.5 sm:px-1",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>h("qty"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-qty",children:["Qty",e.jsx(u,{field:"qty"})]})}),e.jsx(x,{className:"text-right min-w-[60px] px-0.5 sm:px-1",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>h("pnl"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-pnl",children:["P&L",e.jsx(u,{field:"pnl"})]})}),e.jsx(x,{className:"text-right min-w-[55px] px-0.5 sm:px-1",children:e.jsxs(i,{variant:"ghost",size:"sm",onClick:()=>h("pnlPercent"),className:"px-0.5 sm:px-1 h-7 text-[10px] sm:text-xs","data-testid":"sort-pnl-percent",children:[e.jsx("span",{className:"hidden sm:inline",children:"P&L %"}),e.jsx("span",{className:"sm:hidden",children:"%"}),e.jsx(u,{field:"pnlPercent"})]})}),e.jsx(x,{className:"w-[70px] px-1 text-right",children:"Actions"})]})}),e.jsx(pe,{children:E.map(s=>{const{pnl:t,pnlPercent:n,currentPrice:o}=m(s),r=parseFloat(s.averagePurchasePrice),a=t>=0;return e.jsxs(L,{className:"cursor-pointer hover-elevate h-10",onClick:()=>U(`/ticker/${s.ticker}?from=in-position`),"data-testid":`row-position-${s.ticker}`,children:[e.jsx(d,{className:"font-medium font-mono py-1 px-0.5 sm:px-1 text-[11px] sm:text-xs",children:e.jsxs("div",{className:"flex items-center gap-0.5 sm:gap-1.5",children:[e.jsx(z,{className:"h-2.5 sm:h-3 w-2.5 sm:w-3 text-primary"}),e.jsx("span",{children:s.ticker})]})}),e.jsxs(d,{className:"text-right font-mono text-muted-foreground py-1 px-0.5 sm:px-1 text-[10px] sm:text-xs",children:["$",r.toFixed(2)]}),e.jsxs(d,{className:"text-right font-mono py-1 px-0.5 sm:px-1 text-[10px] sm:text-xs",children:["$",o.toFixed(2)]}),e.jsx(d,{className:"text-right font-mono py-1 px-0.5 sm:px-1 text-[10px] sm:text-xs hidden sm:table-cell",children:s.quantity}),e.jsx(d,{className:"text-right py-1 px-0.5 sm:px-1",children:e.jsxs("span",{className:P("font-mono font-medium text-[10px] sm:text-xs",a?"text-success":"text-destructive"),children:[a?"+":"","$",t.toFixed(2)]})}),e.jsx(d,{className:"text-right py-1 px-0.5 sm:px-1",children:e.jsxs("div",{className:P("flex items-center justify-end gap-0.5 text-[10px] sm:text-xs",a?"text-success":"text-destructive"),children:[a?e.jsx(D,{className:"h-3 w-3"}):e.jsx(A,{className:"h-3 w-3"}),e.jsxs("span",{className:"font-mono",children:[a?"+":"",n.toFixed(1),"%"]})]})}),e.jsx(d,{className:"text-right py-1 px-1",onClick:R=>R.stopPropagation(),children:e.jsx(i,{size:"sm",variant:"destructive",className:"h-6 px-2 text-[10px]",onClick:()=>K(s),"data-testid":`button-close-${s.ticker}`,children:"Close"})})]},s.id)})})]})})}),e.jsx(ae,{open:c.open,onOpenChange:s=>N({...c,open:s}),children:e.jsxs(re,{children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"Close Position"}),e.jsx(oe,{children:c.holding&&e.jsxs(e.Fragment,{children:["Are you sure you want to close your position in ",e.jsx("strong",{children:c.holding.ticker}),"?",(()=>{const{pnl:s,pnlPercent:t}=m(c.holding);return e.jsxs("span",{className:P("ml-1",s>=0?"text-success":"text-destructive"),children:["P&L: ",s>=0?"+":"","$",s.toFixed(2)," (",t>=0?"+":"",t.toFixed(1),"%)"]})})()]})})]}),e.jsxs(ce,{children:[e.jsx(i,{variant:"outline",onClick:()=>N({open:!1,holding:null}),"data-testid":"button-cancel-close",children:"Cancel"}),e.jsx(i,{variant:"destructive",onClick:Q,disabled:F.isPending,"data-testid":"button-confirm-close",children:"Close Position"})]})]})})]})}export{Te as default};
